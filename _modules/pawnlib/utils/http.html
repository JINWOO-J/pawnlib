

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pawnlib.utils.http &mdash; Pawnlib v2.1.36</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />

  
      <script src="../../../_static/jquery.js"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
      <script src="../../../_static/doctools.js"></script>
      <script src="../../../_static/sphinx_highlight.js"></script>
      <script src="../../../_static/clipboard.min.js"></script>
      <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pawnlib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome to pawnlib’s documentation!</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Packages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.asyncio.html">pawnlib.asyncio package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.builder.html">pawnlib.builder package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.cli.html">pawnlib.cli package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.config.html">pawnlib.config package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.docker.html">pawnlib.docker package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.exceptions.html">pawnlib.exceptions package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.input.html">pawnlib.input package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.metrics.html">pawnlib.metrics package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.output.html">pawnlib.output package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.resource.html">pawnlib.resource package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.typing.html">pawnlib.typing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module/pawnlib.utils.html">pawnlib.utils package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pawnlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pawnlib.utils.http</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pawnlib.utils.http</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.exceptions.notifier</span><span class="w"> </span><span class="kn">import</span> <span class="n">notify_exception</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.config.globalconfig</span><span class="w"> </span><span class="kn">import</span> <span class="n">pawnlib_config</span> <span class="k">as</span> <span class="n">pawn</span><span class="p">,</span> <span class="n">global_verbose</span><span class="p">,</span> <span class="n">pconf</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">,</span> <span class="n">Null</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.config.logging_config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConsoleLoggerAdapter</span><span class="p">,</span> <span class="n">setup_logger</span><span class="p">,</span> <span class="n">LoggerMixin</span><span class="p">,</span> <span class="n">LoggerMixinVerbose</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.output</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">NoTraceBackException</span><span class="p">,</span>
    <span class="n">dump</span><span class="p">,</span> <span class="n">syntax_highlight</span><span class="p">,</span> <span class="n">kvPrint</span><span class="p">,</span> <span class="n">debug_logging</span><span class="p">,</span>
    <span class="n">PrintRichTable</span><span class="p">,</span> <span class="n">get_debug_here_info</span><span class="p">,</span> <span class="n">print_syntax</span><span class="p">,</span>
    <span class="n">print_json</span><span class="p">,</span>
    <span class="n">pretty_json</span><span class="p">,</span> <span class="n">align_text</span><span class="p">,</span> <span class="n">get_file_extension</span><span class="p">,</span> <span class="n">is_directory</span><span class="p">,</span> <span class="n">is_file</span><span class="p">,</span> <span class="n">print_var</span><span class="p">,</span> <span class="n">print_var2</span><span class="p">,</span> <span class="n">print_grid</span>
    <span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.resource</span><span class="w"> </span><span class="kn">import</span> <span class="n">net</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">append_suffix</span><span class="p">,</span> <span class="n">append_prefix</span><span class="p">,</span> <span class="n">hex_to_number</span><span class="p">,</span> <span class="n">FlatDict</span><span class="p">,</span> <span class="n">Flattener</span><span class="p">,</span> <span class="n">shorten_text</span><span class="p">,</span> <span class="n">StackList</span><span class="p">,</span>
    <span class="n">replace_path_with_suffix</span><span class="p">,</span> <span class="n">format_text</span><span class="p">,</span> <span class="n">format_link</span><span class="p">,</span> <span class="n">list_to_dict_by_key</span><span class="p">,</span>
    <span class="n">get_shortened_tx_hash</span><span class="p">,</span> <span class="n">date_utils</span><span class="p">,</span> <span class="n">HexConverter</span><span class="p">,</span> <span class="n">json_rpc</span><span class="p">,</span> <span class="n">random_token_address</span><span class="p">,</span> <span class="n">generate_json_rpc</span><span class="p">,</span>
    <span class="n">keys_exists</span><span class="p">,</span> <span class="n">is_int</span><span class="p">,</span> <span class="n">is_float</span><span class="p">,</span> <span class="n">list_depth</span><span class="p">,</span> <span class="n">is_valid_token_address</span><span class="p">,</span> <span class="n">sys_exit</span><span class="p">,</span> <span class="n">is_hex</span><span class="p">,</span> <span class="n">is_valid_tx_hash</span><span class="p">,</span> <span class="n">check_key_and_type</span><span class="p">,</span>
    <span class="n">convert_bytes</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.utils.operate_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">WaitStateLoop</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.utils.in_memory_zip</span><span class="w"> </span><span class="kn">import</span> <span class="n">gen_deploy_data_content</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">websocket</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_connection</span><span class="p">,</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">enableTrace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">websocket._exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebSocketConnectionClosedException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.models.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">HexValue</span><span class="p">,</span> <span class="n">HexTintValue</span><span class="p">,</span> <span class="n">HexValueParser</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HTTPStatus</span><span class="p">,</span> <span class="n">ResponseWithElapsed</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">icx_signer</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>  <span class="c1"># Python 3.8+</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>  <span class="c1"># Python 3.7 and below</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">InitVar</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.prompt</span><span class="w"> </span><span class="kn">import</span> <span class="n">Prompt</span><span class="p">,</span> <span class="n">Confirm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.console</span><span class="w"> </span><span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.panel</span><span class="w"> </span><span class="kn">import</span> <span class="n">Panel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rich.syntax</span><span class="w"> </span><span class="kn">import</span> <span class="n">Syntax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">random</span><span class="w"> </span><span class="kn">import</span> <span class="n">uniform</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">SSLError</span><span class="p">,</span> <span class="n">RequestException</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dns.resolver</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>


<span class="n">ALLOWS_HTTP_METHOD</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTPMethodConstants</span><span class="o">.</span><span class="n">get_http_methods</span><span class="p">(</span><span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ALLOW_OPERATOR</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ALLOW_OPERATOR</span>

<span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="fm">__str__</span> <span class="o">=</span> <span class="n">ResponseWithElapsed</span><span class="o">.</span><span class="fm">__str__</span>
<span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">=</span> <span class="n">ResponseWithElapsed</span><span class="o">.</span><span class="fm">__repr__</span>
<span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">ResponseWithElapsed</span><span class="o">.</span><span class="n">error</span>
<span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="n">ResponseWithElapsed</span><span class="o">.</span><span class="n">success</span>
<span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">as_dict</span> <span class="o">=</span> <span class="n">ResponseWithElapsed</span><span class="o">.</span><span class="n">as_dict</span>
<span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">as_simple_dict</span> <span class="o">=</span> <span class="n">ResponseWithElapsed</span><span class="o">.</span><span class="n">as_simple_dict</span>

<span class="n">_ACTIVE_SESSIONS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_force_close_sessions</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forcefully closes open sessions upon program exit.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_ACTIVE_SESSIONS</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="c1"># Handle quietly instead of printing warning messages</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">ResourceWarning</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">_ACTIVE_SESSIONS</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="s1">&#39;connector&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">connector</span><span class="p">,</span> <span class="s1">&#39;_close&#39;</span><span class="p">):</span>
            <span class="n">session</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
    <span class="n">_ACTIVE_SESSIONS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">_force_close_sessions</span><span class="p">)</span>


<div class="viewcode-block" id="StrEnum"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.StrEnum">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">StrEnum</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_next_value_</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">last_values</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="AllowsHttpMethod"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AllowsHttpMethod">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AllowsHttpMethod</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">get</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">delete</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="AllowsKey"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AllowsKey">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AllowsKey</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">status_code</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">reason</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">http_version</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">r_headers</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">response_time</span><span class="o">=</span> <span class="n">auto</span><span class="p">()</span></div>


<div class="viewcode-block" id="NetworkInfo"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NetworkInfo</span><span class="p">:</span>
    <span class="n">network_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">platform</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;icon&quot;</span>
    <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">network_api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">planet_api</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">nid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">network</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">tracker</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">valid_network</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">MANDATORY_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">,</span> <span class="s2">&quot;nid&quot;</span><span class="p">]</span>
    <span class="n">STATIC_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nid&quot;</span><span class="p">,</span> <span class="s2">&quot;network_api&quot;</span><span class="p">,</span> <span class="s2">&quot;endpoint&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;ICX&quot;</span><span class="p">,</span>
                <span class="s2">&quot;network_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;mainnet&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ctz.solidwallet.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;tracker&quot;</span><span class="p">:</span> <span class="s2">&quot;https://tracker.icon.community&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;lisbon&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://lisbon.net.solidwallet.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x2&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;tracker&quot;</span><span class="p">:</span> <span class="s2">&quot;https://tracker.lisbon.icon.community&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;techteam&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://techteam.net.solidwallet.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0xa&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;berlin&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://berlin.net.solidwallet.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x7&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;tracker&quot;</span><span class="p">:</span> <span class="s2">&quot;https://tracker.lisbon.icon.community&quot;</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;cdnet&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;http://20.20.1.122:9000&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x53&quot;</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;havah&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="s2">&quot;HVH&quot;</span><span class="p">,</span>
                <span class="s2">&quot;network_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;mainnet&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;planet_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://planet.havah.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ctz.havah.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x100&quot;</span>  <span class="c1"># 256</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;vega&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;planet_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://planet.vega.havah.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ctz.vega.havah.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x101&quot;</span>  <span class="c1"># 257</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;deneb&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;planet_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://planet.dev.havah.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ctz.dev.havah.io&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x110&quot;</span>  <span class="c1"># 272</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;svm_havah&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="s2">&quot;http://20.20.1.153:9900&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;0x8361&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">()</span>

<div class="viewcode-block" id="NetworkInfo.is_set_static_values"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.is_set_static_values">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_set_static_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">static_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATIC_VALUES</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_network_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves network information based on the network name and platform.</span>

<span class="sd">        Args:</span>
<span class="sd">            network_name (str): The name of the network (e.g., &#39;mainnet&#39;, &#39;vega&#39;).</span>
<span class="sd">            platform (str): The platform name (e.g., &#39;icon&#39;, &#39;havah&#39;).</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the platform or network is invalid and &#39;force&#39; is not enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span> <span class="o">=</span> <span class="n">network_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">network_name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">platform</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">alias_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;veganet&quot;</span><span class="p">:</span> <span class="s2">&quot;vega&quot;</span><span class="p">,</span> <span class="s2">&quot;denebnet&quot;</span><span class="p">:</span> <span class="s2">&quot;deneb&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span> <span class="o">=</span> <span class="n">alias_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="p">)</span>

        <span class="n">platform_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">platform_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                <span class="n">allowed_platforms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid platform &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="si">}</span><span class="s2">&#39;. Allowed platforms: </span><span class="si">{</span><span class="n">allowed_platforms</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">return</span>

        <span class="n">network_info</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;network_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_set_static_values</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">network_info</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                    <span class="n">allowed_networks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">network_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid network &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="si">}</span><span class="s2">&#39; for platform &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;Allowed networks: </span><span class="si">{</span><span class="n">allowed_networks</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="n">network_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_network</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="s1">&#39;network_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="p">,</span>
                <span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_network_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;endpoint&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;network_api&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">[</span><span class="s1">&#39;network_api&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">[</span><span class="s1">&#39;network_api&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_path_with_suffix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">[</span><span class="s1">&#39;network_api&#39;</span><span class="p">],</span> <span class="s2">&quot;/api/v3&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_network_info</span><span class="p">(</span><span class="n">network_name</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_network</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_attributes</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">this_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span>

        <span class="k">if</span> <span class="n">this_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">this_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">this_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

<div class="viewcode-block" id="NetworkInfo.set_network"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.set_network">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">network_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;icon&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">network_name</span> <span class="ow">and</span> <span class="n">platform</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_static_values</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">network_name</span><span class="o">=</span><span class="n">network_name</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">)</span></div>

<div class="viewcode-block" id="NetworkInfo.reset_static_values"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.reset_static_values">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reset_static_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">static_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATIC_VALUES</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">static_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="NetworkInfo.list"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.list">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="NetworkInfo.get_platform_list"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.get_platform_list">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="NetworkInfo.get_platform_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.get_platform_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_platform_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span></div>

<div class="viewcode-block" id="NetworkInfo.update_platform_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.update_platform_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_platform_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{})</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span></div>

<div class="viewcode-block" id="NetworkInfo.add_network"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.add_network">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">,</span> <span class="n">network_name</span><span class="p">,</span> <span class="n">network_api</span><span class="p">,</span> <span class="n">nid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="p">[</span><span class="n">platform</span><span class="p">][</span><span class="s2">&quot;network_info&quot;</span><span class="p">][</span><span class="n">network_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="n">network_api</span><span class="p">,</span>
                <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="n">nid</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="NetworkInfo.get_network_list"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.get_network_list">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_network_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">platform</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">][</span><span class="s1">&#39;network_info&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="NetworkInfo.tuple"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.tuple">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="NetworkInfo.to_dict"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.to_dict">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span></div>

<div class="viewcode-block" id="NetworkInfo.find_network_by_platform_and_nid"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.find_network_by_platform_and_nid">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_network_by_platform_and_nid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find network and endpoint information based on platform and nid.</span>

<span class="sd">        Args:</span>
<span class="sd">            platform (str): The platform name (e.g., &#39;icon&#39;, &#39;havah&#39;).</span>
<span class="sd">            nid (str): The network ID in hexadecimal format (e.g., &#39;0x1&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Network information including endpoint, network_api, and tracker.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the platform or nid is not found in the platform info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">platform_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">platform_info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Platform &#39;</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&#39; is not found. Available platforms: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">network_info</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network_info&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">network_name</span><span class="p">,</span> <span class="n">network_details</span> <span class="ow">in</span> <span class="n">network_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">network_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">nid</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="n">network_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;endpoint&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">replace_path_with_suffix</span><span class="p">(</span>
                    <span class="n">append_http</span><span class="p">(</span><span class="n">network_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network_api&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span> <span class="s2">&quot;/api/v3&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="p">,</span>
                    <span class="s2">&quot;network_name&quot;</span><span class="p">:</span> <span class="n">network_name</span><span class="p">,</span>
                    <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="n">nid</span><span class="p">,</span>
                    <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">endpoint</span><span class="p">,</span>
                    <span class="s2">&quot;network_api&quot;</span><span class="p">:</span> <span class="n">network_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network_api&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;tracker&quot;</span><span class="p">:</span> <span class="n">network_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tracker&quot;</span><span class="p">),</span>
                <span class="p">}</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NID &#39;</span><span class="si">{</span><span class="n">nid</span><span class="si">}</span><span class="s2">&#39; is not found for platform &#39;</span><span class="si">{</span><span class="n">platform</span><span class="si">}</span><span class="s2">&#39;. Available NIDs: </span><span class="si">{</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nid&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">network_info</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NetworkInfo.fetch_network_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.NetworkInfo.fetch_network_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_network_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_api</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[red]Error:[/red] &#39;network_api&#39; is not set. Cannot fetch network information.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_api</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Try fetching network info&quot;</span><span class="p">)</span>
                <span class="n">api_url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="n">append_api_v3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_api</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">IconRpcHelper</span><span class="p">()</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">api_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getNetworkInfo&quot;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[red]Error:[/red] Received an empty response from icx_getNetworkInfo API.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">MANDATORY_KEYS</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">platform_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span> <span class="p">{})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">platform_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                <span class="n">_network_api</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_api</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">network_api</span> <span class="o">=</span> <span class="n">_network_api</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">replace_path_with_suffix</span><span class="p">(</span><span class="n">_network_api</span><span class="p">,</span> <span class="s2">&quot;/api/v3&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">valid_network</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Successfully fetched and updated network info.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]KeyError:[/red] Missing key in result: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Exception occurred while fetching network info:[/red] </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_network_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mandatory_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">,</span> <span class="s2">&quot;network_api&quot;</span><span class="p">,</span> <span class="s2">&quot;nid&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_network_info</span><span class="p">()</span>
        <span class="n">_static_network_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_platform_info&#39;</span><span class="p">,</span> <span class="s1">&#39;static_values&#39;</span><span class="p">,</span> <span class="s1">&#39;network_info&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mandatory_keys</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">_static_network_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_network_info_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_network_info</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt; network_info=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_network_info_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_network_info_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="IconRpcTemplates"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">IconRpcTemplates</span><span class="p">:</span>
    <span class="n">requires_sign_method</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;icx_sendTransaction&#39;</span><span class="p">,</span> <span class="s1">&#39;icx_sendTransaction(SCORE)&#39;</span><span class="p">,</span> <span class="s1">&#39;icx_call&#39;</span><span class="p">]</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;main_api&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1"># &quot;icx_getTotalSupply&quot;: json_rpc(&quot;icx_getTotalSupply&quot;),</span>
            <span class="s2">&quot;icx_getTotalSupply&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;icx_getLastBlock&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;icx_getBalance&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;icx_getTransactionResult&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;icx_getTransactionByHash&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;icx_getBlockByHeight&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;icx_getBlockByHash&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;icx_getScoreApi&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;icx_getScoreStatus&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;debug_getTrace&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}},</span>
            <span class="s2">&quot;debug_estimateStep&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{}},</span>
            <span class="s2">&quot;icx_getNetworkInfo&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;icx_call&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
            <span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stepLimit&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0x3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nonce&quot;</span><span class="p">:</span> <span class="s2">&quot;0x23&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s2">&quot;icx_sendTransaction(SCORE)&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;IISS&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;setStake&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;setStake&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_rpc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params_hint</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_rpc</span><span class="p">()</span>

<div class="viewcode-block" id="IconRpcTemplates.update_template"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.update_template">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_template</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">new_template</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcTemplates.get_category"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.get_category">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_category</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="IconRpcTemplates.get_methods"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.get_methods">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_category</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_category</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_category</span> <span class="o">==</span> <span class="n">category</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_category</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">methods</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_category</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">methods</span></div>

<div class="viewcode-block" id="IconRpcTemplates.create_rpc"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.create_rpc">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">pass</span></div>

<div class="viewcode-block" id="IconRpcTemplates.is_required_sign"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.is_required_sign">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_required_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires_sign_method</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_rpc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_rpc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="IconRpcTemplates.load_template"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.load_template">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_category</span><span class="p">:</span>
            <span class="n">_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_category</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_template</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">_template</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_template</span></div>

<div class="viewcode-block" id="IconRpcTemplates.get_rpc"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.get_rpc">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_category</span> <span class="o">=</span> <span class="n">category</span>
        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="n">_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_template</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="ow">and</span> <span class="n">_template</span><span class="p">:</span>
            <span class="n">_arguments</span> <span class="o">=</span> <span class="n">_template</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_arguments</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Template Error] Syntax Error -&gt; category=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_category</span><span class="si">}</span><span class="s2">, method=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Template Error] Required method -&gt;  category=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_category</span><span class="si">}</span><span class="s2">, method=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params_hint&#39;</span><span class="p">,</span> <span class="s2">&quot;__NOT_DEFINED__&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;__NOT_DEFINED__&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_params_hint</span> <span class="o">=</span> <span class="n">_arguments</span><span class="p">[</span><span class="s1">&#39;params_hint&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">_arguments</span><span class="p">[</span><span class="s1">&#39;params_hint&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_arguments</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_arguments</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">sys_exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Params error </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


                <span class="bp">self</span><span class="o">.</span><span class="n">return_rpc</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span><span class="o">**</span><span class="n">_arguments</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">sys_exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Params error </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">return_rpc</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_rpc</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="IconRpcTemplates.get_required_params"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.get_required_params">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span></div>

<div class="viewcode-block" id="IconRpcTemplates.get_params_hint"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcTemplates.get_params_hint">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_params_hint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params_hint</span></div></div>


<div class="viewcode-block" id="IconRpcHelper"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">IconRpcHelper</span><span class="p">(</span><span class="n">LoggerMixinVerbose</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">wallet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">network_info</span><span class="p">:</span> <span class="n">NetworkInfo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">raise_on_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">required_sign_methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wait_sleep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tx_method</span><span class="o">=</span><span class="s2">&quot;icx_getTransactionResult&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">margin_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">wallet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="n">network_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_failure</span> <span class="o">=</span> <span class="n">raise_on_failure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_sleep</span> <span class="o">=</span> <span class="n">wait_sleep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_method</span> <span class="o">=</span> <span class="n">tx_method</span>

        <span class="c1"># self.logger = setup_logger(logger, &quot;IconRpcHelper&quot;, verbose)</span>
        <span class="c1"># self.logger = self.get_logger()</span>

        <span class="c1"># super().__init__()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># print_var(self.logger)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">margin_steps</span> <span class="o">=</span> <span class="n">margin_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start IconRpcHelper&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">required_sign_methods</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">required_sign_methods</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">required_sign_methods</span> <span class="o">=</span> <span class="n">required_sign_methods</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">required_sign_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;unregister&quot;</span><span class="p">,</span> <span class="s2">&quot;claim&quot;</span><span class="p">,</span> <span class="s2">&quot;vote&quot;</span><span class="p">,</span> <span class="s2">&quot;apply&quot;</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="s2">&quot;cancel&quot;</span><span class="p">,</span> <span class="s2">&quot;acceptScore&quot;</span><span class="p">,</span> <span class="s2">&quot;reject&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">network_api</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">replace_path_with_suffix</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;/api/v3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_url</span> <span class="o">=</span> <span class="n">replace_path_with_suffix</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;/api/v3d&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_method</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_global_request_payload</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_request_payload</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_api</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_stack</span> <span class="o">=</span> <span class="n">StackList</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timing_stack</span> <span class="o">=</span> <span class="n">StackList</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stepLimit&quot;</span><span class="p">:</span> <span class="nb">hex</span><span class="p">(</span><span class="mi">2500000</span><span class="p">)</span>
        <span class="p">}</span>

<div class="viewcode-block" id="IconRpcHelper.set_use_hex_value"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.set_use_hex_value">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_use_hex_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c1"># Additional logic can be added here (e.g., logging)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use_hex_value must be a boolean.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.test_logger"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.test_logger">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test_logger&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.initialize"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.initialize">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_governance_address</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not found network_info&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_wallet</span><span class="p">()</span></div>

<div class="viewcode-block" id="IconRpcHelper.initialize_wallet"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.initialize_wallet">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_wallet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wallet</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wallet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">wallet</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading wallet from icx_signer.load_wallet_key()&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">icx_signer</span><span class="o">.</span><span class="n">load_wallet_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_wallet_address"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_wallet_address">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_wallet_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wallet</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wallet</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">icx_signer</span><span class="o">.</span><span class="n">load_wallet_key</span><span class="p">(</span><span class="n">wallet</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_governance_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;havah&quot;</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">and</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">GOVERNANCE_ADDRESS</span>

        <span class="c1"># If governance_address is still not set, default to GOVERNANCE_ADDRESS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="ow">or</span> <span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_governance_address_with_const</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="n">rpc_api_methods</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;havah&quot;</span><span class="p">:</span>
            <span class="n">rpc_api_methods</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">HAVAH_METHODS</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;icon&quot;</span><span class="p">:</span>
            <span class="n">rpc_api_methods</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">ICON_METHODS</span>

        <span class="k">if</span> <span class="n">rpc_api_methods</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">score_address</span><span class="p">,</span> <span class="n">score_methods</span> <span class="ow">in</span> <span class="n">rpc_api_methods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">score_methods</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="n">score_address</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decorator_enforce_kwargs</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start &#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">&#39; function&quot;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">from_kwargs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_str_to_dict</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">payload</span>
            <span class="k">return</span> <span class="n">payload_dict</span>

        <span class="k">return</span> <span class="n">payload</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_valid_url_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="n">append_api_v3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid url: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_valid_payload_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
            <span class="n">_request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_str_to_dict</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_request_payload</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_request_payload</span>

<div class="viewcode-block" id="IconRpcHelper.rpc_call"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.rpc_call">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">rpc_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                 <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
                 <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
                 <span class="n">print_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">reset_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">raise_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">http_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>

        <span class="k">if</span> <span class="n">raise_on_failure</span><span class="p">:</span>
            <span class="n">_raise_on_failure</span> <span class="o">=</span> <span class="n">raise_on_failure</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_raise_on_failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_failure</span>

        <span class="n">_url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="n">append_api_v3</span><span class="p">(</span><span class="n">_url</span><span class="p">))</span>
        <span class="n">_request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_valid_payload_format</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reset_error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">store_request_payload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_request_payload</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">CallHttp</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">_url</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">http_method</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">_request_payload</span><span class="p">,</span>
            <span class="n">raise_on_failure</span><span class="o">=</span><span class="n">_raise_on_failure</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status_code&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_error_message</span><span class="p">(</span><span class="n">print_error</span><span class="p">)</span>

        <span class="c1"># pawn.console.log(self.response.get(&#39;elapsed&#39;), self.response.get(&#39;timing&#39;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elapsed&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timing_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timing&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">),</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_elapsed"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_elapsed">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;elapsed&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;elapsed&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_stack</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;timing&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing_stack</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_total_elapsed"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_total_elapsed">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_total_elapsed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.print_error_message"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.print_error_message">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_error_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">print_error</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][ERROR][/red] payload=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][ERROR] status_code=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, error=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status_code&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">999</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][ERROR][/red] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># self.exit_on_failure(f&quot;[red][ERROR][/red] {self.response.get(&#39;error&#39;)}&quot;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][ERROR][/red] url=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, status_code=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status_code&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, text=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.print_response"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.print_response">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hex_to_int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status_code&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;rule.line&quot;</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;Response </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status_code&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">characters</span><span class="o">=</span><span class="s2">&quot;═&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
            <span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">),</span> <span class="n">hex_to_int</span><span class="o">=</span><span class="n">hex_to_int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">syntax_highlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="IconRpcHelper.print_request"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.print_request">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;Request&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">syntax_highlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span><span class="p">,</span> <span class="n">line_indent</span><span class="o">=</span><span class="s1">&#39;   &#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="IconRpcHelper.make_params"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.make_params">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">json_rpc</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span>
        <span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_signable_governance_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># if self.network_info.platform == &quot;havah&quot; or self.network_info.platform == &quot;icon&quot; and method:</span>
        <span class="k">if</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">required_sign_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_sign_methods</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">required_sign_method</span><span class="p">):</span>
                    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, It will be signed with the following. required_sign_methods=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">required_sign_methods</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="IconRpcHelper.create_governance_payload"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.create_governance_payload">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_governance_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{}):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_signable_governance_method</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span><span class="p">:</span>
            <span class="n">parent_method</span> <span class="o">=</span> <span class="s2">&quot;icx_sendTransaction&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_method</span> <span class="o">=</span> <span class="s2">&quot;icx_call&quot;</span>
        <span class="n">_request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_valid_payload_format</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="n">parent_method</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span><span class="p">,</span>
                <span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_request_payload</span></div>

<div class="viewcode-block" id="IconRpcHelper.governance_call"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.governance_call">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">governance_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">governance_address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">sign</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;0x0&quot;</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">governance_address</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="n">governance_address</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_governance_address_with_const</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sign</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span> <span class="o">=</span> <span class="n">sign</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Does the method require a signature? _can_be_signed=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_governance_payload</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_can_be_signed</span><span class="p">:</span>
            <span class="c1"># if _request_payload[&#39;params&#39;].get(&#39;value&#39;, None):</span>
            <span class="n">_request_payload</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">_request_payload</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_send</span><span class="p">(</span><span class="n">is_wait</span><span class="o">=</span><span class="n">is_wait</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="n">_request_payload</span><span class="p">,</span>
                <span class="n">print_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">store_request_payload</span><span class="o">=</span><span class="n">store_request_payload</span><span class="p">,</span>
                <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="IconRpcHelper.create_deploy_payload"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.create_deploy_payload">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_deploy_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">governance_address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span> <span class="o">=</span> <span class="n">governance_address</span> <span class="k">if</span> <span class="n">governance_address</span> <span class="k">else</span> <span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span>
        <span class="n">file_extension_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;jar&quot;</span><span class="p">:</span> <span class="s2">&quot;java&quot;</span>
        <span class="p">}</span>
        <span class="n">_file_extension</span> <span class="o">=</span> <span class="n">get_file_extension</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_file</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">_file_type</span> <span class="o">=</span> <span class="n">file_extension_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_file_extension</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_file_extension</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid SCORE source - &#39;</span><span class="si">{</span><span class="n">src</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">force_exit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">_content</span> <span class="o">=</span> <span class="n">gen_deploy_data_content</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;file_extension=</span><span class="si">{</span><span class="n">_file_extension</span><span class="si">}</span><span class="s2">, file_type=</span><span class="si">{</span><span class="n">_file_type</span><span class="si">}</span><span class="s2">, content_size=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_content</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_valid_payload_format</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_address</span><span class="p">,</span>
                <span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;deploy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;contentType&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;application/</span><span class="si">{</span><span class="n">_file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;0x</span><span class="si">{</span><span class="n">_content</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="n">_request_payload</span>
        <span class="k">return</span> <span class="n">_request_payload</span></div>

<div class="viewcode-block" id="IconRpcHelper.deploy_score"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.deploy_score">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">deploy_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_confirm_send</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_deploy_payload</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">governance_address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_confirm_send</span><span class="p">:</span>
            <span class="n">print_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span><span class="p">)</span>
            <span class="n">is_send</span> <span class="o">=</span> <span class="n">Confirm</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;Do you want to send the [bold red]deploy[/bold red] transaction?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_send</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">is_send</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_send</span><span class="p">(</span><span class="n">is_wait</span><span class="o">=</span><span class="n">is_wait</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_step_price"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_step_price">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_step_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;getStepPrice&quot;</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_step_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;getStepCosts&quot;</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="IconRpcHelper.get_step_cost"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_step_cost">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_step_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_kind</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_step_costs</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_kind</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_estimate_step"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_estimate_step">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_estimate_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_url</span>

        <span class="n">_tx</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="n">_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_fill_parameter</span><span class="p">(</span><span class="n">_tx</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_tx</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;debug_estimateStep&quot;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">_url</span><span class="p">,</span>
                <span class="n">payload</span><span class="o">=</span><span class="n">_tx</span><span class="p">,</span>
                <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">print_error</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">res_json</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">if</span> <span class="n">res_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
                <span class="c1"># pawn.console.debug(f&quot;[red] An error occurred while running debug_estimateStep, {res_json[&#39;error&#39;].get(&#39;message&#39;)}&quot;)</span>
                <span class="c1"># sys.exit(-1)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while running &#39;debug_estimateStep&#39;, </span><span class="si">{</span><span class="n">res_json</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, URL=</span><span class="si">{</span><span class="n">_url</span><span class="si">}</span><span class="s2">, _tx=</span><span class="si">{</span><span class="n">_tx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TX is not dict. tx =&gt; </span><span class="si">{</span><span class="n">_tx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_step_limit"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_step_limit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_step_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_kind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tx</span><span class="p">:</span>
            <span class="n">_tx</span> <span class="o">=</span> <span class="n">tx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_tx</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span><span class="p">)</span>
        <span class="n">unnecessary_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stepLimit&quot;</span><span class="p">,</span> <span class="s2">&quot;signature&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">unnecessary_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;__NOT_DEFINED__&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;__NOT_DEFINED__&quot;</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remove the unnecessary &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in payload&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="n">estimate_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_estimate_step</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">_tx</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">step_kind</span><span class="p">:</span>
            <span class="n">step_kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guess_step_kind</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">_tx</span><span class="p">)</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;guess step_kind = </span><span class="si">{</span><span class="n">step_kind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">step_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_cost</span><span class="p">(</span><span class="n">step_kind</span><span class="p">)</span>
        <span class="n">step_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_price</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">estimate_step</span> <span class="ow">and</span> <span class="n">step_cost</span><span class="p">:</span>
            <span class="c1"># step_limit = hex(hex_to_number(estimate_step) + hex_to_number(step_cost))</span>
            <span class="n">step_limit</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">hex_to_number</span><span class="p">(</span><span class="n">estimate_step</span><span class="p">)</span><span class="o">+</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin_steps</span><span class="p">))</span>
            <span class="c1"># step_limit = hex(hex_to_number(estimate_step))</span>
            <span class="n">icx_fee</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">estimate_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">step_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">TINT</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fee = </span><span class="si">{</span><span class="n">icx_fee</span><span class="si">}</span><span class="s2"> =&gt; estimate[i](</span><span class="si">{</span><span class="n">hex_to_number</span><span class="p">(</span><span class="n">estimate_step</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">)[/i] * &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;step_price[i](</span><span class="si">{</span><span class="n">hex_to_number</span><span class="p">(</span><span class="n">step_price</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">)[/i]&quot;</span><span class="p">)</span>

            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;step_limit =&gt; </span><span class="si">{</span><span class="n">hex_to_number</span><span class="p">(</span><span class="n">step_limit</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">step_limit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_default_step_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stepLimit&quot;</span><span class="p">)</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][FAIL][/red] An error occurred while running get_step_limit(). set default : </span><span class="si">{</span><span class="n">_default_step_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_default_step_limit</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_guess_step_kind</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">step_kind_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;deploy&quot;</span><span class="p">:</span> <span class="s2">&quot;contractCreate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;call&quot;</span><span class="p">:</span> <span class="s2">&quot;apiCall&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">_default_step_kind</span> <span class="o">=</span> <span class="s2">&quot;get&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_default_step_kind</span>

        <span class="k">for</span> <span class="n">payload_key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">step_kind_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">keys_exists</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="n">payload_key</span><span class="p">):</span>
                <span class="n">_data_type</span> <span class="o">=</span> <span class="n">tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="n">payload_key</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">step_kind_dict</span><span class="p">[</span><span class="n">payload_key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">_data_type</span><span class="p">,</span> <span class="n">_default_step_kind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_default_step_kind</span>

<div class="viewcode-block" id="IconRpcHelper.get_fee"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_fee">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">step_kind</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_tx_var</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys_exists</span><span class="p">(</span><span class="n">_tx</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="s2">&quot;stepLimit&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;stepLimit&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">keys_exists</span><span class="p">(</span><span class="n">_tx</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="s2">&quot;signature&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;signature&#39;</span><span class="p">]</span>
        <span class="n">estimate_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_estimate_step</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">_tx</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">step_kind</span><span class="p">:</span>
            <span class="n">step_kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guess_step_kind</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_guess_step_kind = </span><span class="si">{</span><span class="n">step_kind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">step_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_cost</span><span class="p">(</span><span class="n">step_kind</span><span class="p">)</span>
        <span class="n">step_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_price</span><span class="p">()</span>
        <span class="n">step_limit</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">hex_to_number</span><span class="p">(</span><span class="n">estimate_step</span><span class="p">)</span> <span class="o">+</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">step_cost</span><span class="p">))</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">estimate_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">step_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">TINT</span>

        <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
            <span class="n">fee</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fee</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fee = (estimate_step + step_cost) * step_price = </span><span class="si">{</span><span class="n">fee</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fee = (</span><span class="si">{</span><span class="n">estimate_step</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">step_cost</span><span class="si">}</span><span class="s2">) * </span><span class="si">{</span><span class="n">step_price</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">fee</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;step_limit = </span><span class="si">{</span><span class="n">step_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fee</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_score_api"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_score_api">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_score_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_token_address</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;cx&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token address - </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getScoreApi&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">},</span>
            <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="p">[])</span></div>

<div class="viewcode-block" id="IconRpcHelper.name_to_params"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.name_to_params">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name_to_params</span><span class="p">(</span><span class="n">list_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">list_data</span><span class="p">}</span></div>

<div class="viewcode-block" id="IconRpcHelper.make_params_hint"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.make_params_hint">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_params_hint</span><span class="p">(</span><span class="n">list_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">formatted_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">list_data</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">formatted_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">formatted_data</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_score_api_to_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[],</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">return_method_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">return_method_only</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">_input</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;icx_call&quot;</span> <span class="k">if</span> <span class="n">_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;0x1&quot;</span> <span class="k">else</span> <span class="s2">&quot;icx_sendTransaction&quot;</span>
            <span class="n">score_method</span> <span class="o">=</span> <span class="n">_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_method_only</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_method</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">score_method</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">dataType</span><span class="o">=</span><span class="s2">&quot;call&quot;</span><span class="p">,</span>
                        <span class="n">to</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">method</span><span class="o">=</span><span class="n">score_method</span><span class="p">,</span>
                            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name_to_params</span><span class="p">(</span><span class="n">_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">))</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">params_hint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_params_hint</span><span class="p">(</span><span class="n">_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">))</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;icx_sendTransaction&quot;</span> <span class="ow">and</span> <span class="n">_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;payable&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;0x1&quot;</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">score_method</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0x0&quot;</span>
            <span class="c1"># pawn.console.log(f&quot;{_input.get(&#39;type&#39;)} {score_method} , {_input.get(&#39;inputs&#39;)}, {_input.get(&#39;readonly&#39;)}&quot;)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="IconRpcHelper.get_governance_api"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_governance_api">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_governance_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_method_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_api</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">GOVERNANCE_ADDRESS</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">]:</span>
            <span class="n">_api_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_score_api</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_api_result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">score_api</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_score_api_to_params</span><span class="p">(</span><span class="n">_api_result</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">return_method_only</span><span class="o">=</span><span class="n">return_method_only</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_api</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_balance"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_balance">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_comma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_as_decimal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the balance of the given address.</span>

<span class="sd">        :param url: RPC URL.</span>
<span class="sd">        :param address: Address to get the balance for.</span>
<span class="sd">        :param is_comma: Whether to format the number with commas.</span>
<span class="sd">        :param is_tint: Whether to return as TINT.</span>
<span class="sd">        :param return_as_hex: Whether to return the balance in its raw hex form.</span>
<span class="sd">        :param return_as_decimal: If True, returns the balance as a floating-point number in ICX.</span>
<span class="sd">        :param use_hex_value: If True, returns a HexValue object instead of a raw balance.</span>
<span class="sd">        :return: Balance in the requested format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_valid_token_address</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getBalance&quot;</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">},</span>
                <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">_balance</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span>

            <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">_balance</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_balance</span>

            <span class="n">balance_number</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">_balance</span><span class="p">,</span> <span class="n">is_comma</span><span class="o">=</span><span class="n">is_comma</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="n">is_tint</span><span class="p">)</span>

            <span class="c1"># If as_float is requested, convert the balance to a float in ICX (from wei)</span>
            <span class="k">if</span> <span class="n">return_as_decimal</span><span class="p">:</span>
                <span class="n">balance_float</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">balance_number</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">balance_float</span>
            <span class="k">return</span> <span class="n">balance_number</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid token address - </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.analyze_tx_block_time"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.analyze_tx_block_time">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_tx_block_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
        <span class="n">tx_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">block_height</span> <span class="o">=</span> <span class="n">transaction</span><span class="p">[</span><span class="s1">&#39;blockHeight&#39;</span><span class="p">]</span>
        <span class="n">block_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="n">block_height</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.time_stamp&quot;</span><span class="p">)</span>

        <span class="c1"># pawn.console.log(f&quot;diff_time={(tx_timestamp-block_timestamp)/1_000_000}&quot;)</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_timestamp</span><span class="o">-</span><span class="n">block_timestamp</span><span class="p">)</span><span class="o">/</span><span class="mi">1_000_000</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># &quot;tx_hash&quot;: tx_hash,</span>
            <span class="s2">&quot;tx_timestamp&quot;</span><span class="p">:</span> <span class="n">tx_timestamp</span><span class="p">,</span>
            <span class="s2">&quot;block_height&quot;</span><span class="p">:</span> <span class="n">block_height</span><span class="p">,</span>
            <span class="s2">&quot;block_timestamp&quot;</span><span class="p">:</span> <span class="n">block_timestamp</span><span class="p">,</span>
            <span class="s2">&quot;elapsed_time&quot;</span><span class="p">:</span> <span class="n">elapsed_time</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_block"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_block">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">block_height</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="s2">&quot;Required block_height for get_block()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">block_height</span><span class="p">):</span>
            <span class="n">_block_height</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">block_height</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_hex</span><span class="p">(</span><span class="n">block_height</span><span class="p">):</span>
            <span class="n">_block_height</span> <span class="o">=</span> <span class="n">block_height</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getBlockByHeight&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">_block_height</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">return_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FlatDict</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">return_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_stake"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_stake">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.stake&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>

        <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;getStake&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_bond"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_bond">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.bonds&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>

        <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;getBond&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_delegation"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_delegation">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.delegations&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>

        <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;getDelegation&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_iscore"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_iscore">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_iscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.estimatedICX&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>

        <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;queryIScore&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span><span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.claim_iscore"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.claim_iscore">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">claim_iscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
        <span class="n">_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;claimIScore&quot;</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="n">is_wait</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">_response</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="IconRpcHelper.unjail"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.unjail">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">unjail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
        <span class="n">_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;requestUnjail&quot;</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="n">is_wait</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">_response</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="IconRpcHelper.handle_response_with_key"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.handle_response_with_key">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_response_with_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">return_key</span> <span class="ow">and</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">FlatDict</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">return_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_tx"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_tx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">tx_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tx_hash</span><span class="p">:</span>
            <span class="n">tx_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tx_hash</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_tx_hash</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid tx_hash - </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="c1"># method=&quot;icx_getTransactionResult&quot;,</span>
            <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_method</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="n">tx_hash</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">use_hex_value</span> <span class="o">=</span> <span class="n">use_hex_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">return_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">return_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.get_tx_wait"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_tx_wait">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tx_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">tx_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">is_compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_block_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tx_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tx_hash</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tx_hash</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">_live</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pawn</span><span class="p">,</span> <span class="s2">&quot;console_status&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console_status</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pawn</span><span class="p">,</span> <span class="s2">&quot;console_status&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_transaction_loop</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">is_compact</span><span class="p">,</span> <span class="n">pawn</span><span class="o">.</span><span class="n">console_status</span><span class="p">,</span> <span class="n">is_block_time</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;[magenta] Wait for transaction to be generated.&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_transaction_loop</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">is_compact</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">is_block_time</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span></div>

<div class="viewcode-block" id="IconRpcHelper.check_transaction_loop"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.check_transaction_loop">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_transaction_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">is_compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_block_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the transaction loop until a result is received or max_attempts is reached.</span>

<span class="sd">        :param tx_hash: The transaction hash.</span>
<span class="sd">        :param url: The URL for the transaction.</span>
<span class="sd">        :param is_compact: Whether to display a compact result.</span>
<span class="sd">        :param status: Status object for logging progress.</span>
<span class="sd">        :param is_block_time: Whether to include block elapsed time in the result.</span>
<span class="sd">        :param max_attempts: Maximum number of attempts before exiting the loop (None for unlimited).</span>
<span class="sd">        :return: The final response.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exit_loop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_transaction</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
                <span class="n">text</span><span class="p">,</span> <span class="n">exit_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_error_response</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_block_time</span><span class="p">:</span>
                    <span class="n">block_elapsed_time</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_tx_block_time</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elapsed_time&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&gt; &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">block_elapsed_time</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">text</span><span class="p">,</span> <span class="n">exit_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_success_response</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">prefix_text</span><span class="o">=</span><span class="n">block_elapsed_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">resp</span>

            <span class="n">wait_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wait_callback&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">wait_callback</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">wait_callback</span><span class="p">):</span>
                <span class="n">wait_callback</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;update&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
                    <span class="n">spinner_style</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Check if max_attempts is reached</span>
            <span class="k">if</span> <span class="n">max_attempts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">max_attempts</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reached maximum attempts (</span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2">) for transaction </span><span class="si">{</span><span class="n">get_shortened_tx_hash</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">detailed_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Response: </span><span class="si">{</span><span class="n">resp</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]:</span>
                    <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Reason: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="c1"># self.on_error = True</span>
                    <span class="n">text</span><span class="p">,</span> <span class="n">exit_loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_error_response</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">detailed_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># pawn.console.log(f&quot;[green] text={text}, exit={exit_loop} &quot;)</span>
                    <span class="c1"># break</span>
                <span class="c1">#</span>
                <span class="c1">#     return resp</span>
                <span class="c1"># return detailed_message</span>

            <span class="k">if</span> <span class="n">exit_loop</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_final_result</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">is_compact</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_sleep</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="ow">and</span> <span class="n">tx_hash</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_debug_trace</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">reset_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resp</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_tx_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tx_hash</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tx_hash not found. It will be found in the self.response&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keys_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;txHash&#39;</span><span class="p">):</span>
                <span class="n">tx_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;txHash&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">keys_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">):</span>
                <span class="n">tx_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tx_hash</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] Not found tx_hash=&#39;</span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span>  <span class="n">is_valid_tx_hash</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tx_hash</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] Invalid tx_hash value = </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tx</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">tx_hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_error_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">):</span>
        <span class="n">exit_loop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">exit_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">prefix_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[cyan][Wait TX][</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">][/cyan] Check a transaction by [i cyan]</span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">[/i cyan] &quot;</span>
        <span class="n">_error_message</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
        <span class="n">exit_error_messages</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;InvalidParams&quot;</span><span class="p">,</span> <span class="s2">&quot;NotFound: E1005:not found tx id&quot;</span><span class="p">,</span> <span class="s2">&quot;Reached maximum attempts&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">error_message</span> <span class="ow">in</span> <span class="n">_error_message</span> <span class="k">for</span> <span class="n">error_message</span> <span class="ow">in</span> <span class="n">exit_error_messages</span><span class="p">):</span>
            <span class="n">exit_loop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">exit_msg</span> <span class="o">=</span> <span class="s2">&quot;[red][FAIL][/red]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}{</span><span class="n">exit_msg</span><span class="si">}</span><span class="s2">[white] &#39;</span><span class="si">{</span><span class="n">_error_message</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">exit_loop</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_success_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">prefix_text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="c1"># if resp[&#39;result&#39;].get(&#39;logsBloom&#39;):</span>
        <span class="c1">#     resp[&#39;result&#39;][&#39;logsBloom&#39;] = int(resp[&#39;result&#39;][&#39;logsBloom&#39;], 16)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;failure&#39;</span><span class="p">):</span>
            <span class="n">_resp_status</span> <span class="o">=</span> <span class="s2">&quot;[red][FAIL][/red]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_resp_status</span> <span class="o">=</span> <span class="s2">&quot;[green][OK][/green]&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">exit_loop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">prefix_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[cyan][Wait TX][</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">][/cyan] </span><span class="si">{</span><span class="n">prefix_text</span><span class="si">}</span><span class="s2">Check a transaction by [i cyan]</span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">[/i cyan] &quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">align_text</span><span class="p">(</span><span class="n">prefix_text</span><span class="p">,</span> <span class="n">_resp_status</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">exit_loop</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_final_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">is_compact</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[bold green][white]</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">is_compact</span><span class="p">:</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">shorten_text</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">use_tags</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">tprint</span><span class="p">(</span><span class="n">final_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">or</span> <span class="n">pawn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PAWN_DEBUG&#39;</span><span class="p">):</span>
            <span class="n">print_json</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="IconRpcHelper.get_debug_trace"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.get_debug_trace">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_debug_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">print_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reset_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_url</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;debug_getTrace&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="n">tx_hash</span><span class="p">},</span>
            <span class="n">store_request_payload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">reset_error</span><span class="o">=</span><span class="n">reset_error</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">keys_exists</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">print_table</span><span class="p">:</span>
            <span class="n">PrintRichTable</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;debug_getTrace=</span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;logs&#39;</span><span class="p">],</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="IconRpcHelper.parse_tx_var"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.parse_tx_var">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_tx_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tx</span><span class="p">:</span>
            <span class="n">_tx</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_global_request_payload</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span><span class="p">:</span>
                <span class="n">_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_request_payload</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_global_request_payload</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># pawn.console.debug(f&quot;[red]_use_global_request_payload={self._use_global_request_payload}&quot;)</span>
        <span class="k">return</span> <span class="n">_tx</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_force_fill_from_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="s2">&quot;Not found &#39;from address&#39;. Not defined wallet&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="IconRpcHelper.auto_fill_parameter"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.auto_fill_parameter">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">auto_fill_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_force_from_addr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_tx_var</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_tx</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_force_from_addr</span><span class="p">:</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_fill_from_address</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nonce&#39;</span><span class="p">):</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;nonce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0x1&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">):</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;0x3&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">):</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">icx_signer</span><span class="o">.</span><span class="n">get_timestamp_us</span><span class="p">())</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">nid</span><span class="p">:</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;nid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">nid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid payload =&gt; </span><span class="si">{</span><span class="n">_tx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_global_request_payload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="n">_tx</span>
        <span class="k">return</span> <span class="n">_tx</span></div>

<div class="viewcode-block" id="IconRpcHelper.auto_fill_step_limit"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.auto_fill_step_limit">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">auto_fill_step_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_tx_var</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_tx</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">step_limit</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_hex</span><span class="p">(</span><span class="n">step_limit</span><span class="p">):</span>
                    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting step limit to hex </span><span class="si">{</span><span class="n">step_limit</span><span class="si">}</span><span class="s2">=&gt;</span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">step_limit</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">step_limit</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">step_limit</span><span class="p">))</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;stepLimit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_limit</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stepLimit&#39;</span><span class="p">):</span>
                <span class="n">_tx</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;stepLimit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_limit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid payload =&gt; </span><span class="si">{</span><span class="n">_tx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.sign_tx"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.sign_tx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sign_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wallet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_balance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">wallet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="o">=</span> <span class="n">wallet</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] Not defined wallet =&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">payload</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_request_payload</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Use global_request_payload&quot;</span><span class="p">)</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_request_payload</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_valid_payload_format</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;private_key&#39;</span><span class="p">)</span>
        <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wallet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># if self.request_payload.get(&#39;params&#39;) and  not keys_exists(self.request_payload, &quot;params&quot;, &quot;value&quot;):</span>
        <span class="c1">#     self.request_payload[&#39;params&#39;][&#39;value&#39;] = &quot;0x0&quot;</span>

        <span class="k">if</span> <span class="n">check_balance</span><span class="p">:</span>
            <span class="n">_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">symbol</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&gt;&#39;s Balance = </span><span class="si">{</span><span class="n">_balance</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_balance</span> <span class="ow">or</span> <span class="n">_balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&gt; Out of Balance = </span><span class="si">{</span><span class="n">_balance</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_fill_parameter</span><span class="p">(</span><span class="n">is_force_from_addr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_fill_step_limit</span><span class="p">(</span><span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>
        <span class="n">singer</span> <span class="o">=</span> <span class="n">icx_signer</span><span class="o">.</span><span class="n">IcxSigner</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">private_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span> <span class="o">=</span> <span class="n">singer</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">address</span> <span class="o">!=</span> <span class="n">singer</span><span class="o">.</span><span class="n">get_hx_address</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid address </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">singer</span><span class="o">.</span><span class="n">get_hx_address</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">global_request_payload</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span></div>

<div class="viewcode-block" id="IconRpcHelper.exit_on_failure"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.exit_on_failure">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">force_exit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_failure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoTraceBackException</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][FAIL][/red] Stopped </span><span class="si">{</span><span class="n">get_debug_here_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;function_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">(), </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">force_exit</span><span class="p">:</span>
                <span class="n">sys_exit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">exception</span></div>

<div class="viewcode-block" id="IconRpcHelper.sign_send"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.sign_send">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">sign_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_block_time</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signed_tx</span><span class="p">,</span> <span class="n">print_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_wait</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">):</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tx_wait</span><span class="p">(</span><span class="n">tx_hash</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">],</span> <span class="n">is_compact</span><span class="o">=</span><span class="n">is_compact</span><span class="p">,</span> <span class="n">is_block_time</span><span class="o">=</span><span class="n">is_block_time</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">resp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required signed transaction&quot;</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_tx_result</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="c1"># print(result)</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">response_json</span>

<div class="viewcode-block" id="IconRpcHelper.preview_transaction_fee"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.preview_transaction_fee">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">preview_transaction_fee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_in_loop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_decimal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate the transaction fee for a given payload.</span>

<span class="sd">        :param payload: The transaction payload for which the fee is to be estimated.</span>
<span class="sd">        :type payload: dict</span>
<span class="sd">        :param margin_steps: Additional steps to add to the estimated step limit (default: 0).</span>
<span class="sd">        :type margin_steps: int</span>
<span class="sd">        :param return_in_loop: If True, returns the transaction fee in LOOP (smallest unit). Defaults to False (ICX).</span>
<span class="sd">        :type return_in_loop: bool</span>
<span class="sd">        :param use_decimal: If True, use Decimal for calculations to maintain precision. Defaults to False.</span>
<span class="sd">        :type use_decimal: bool</span>
<span class="sd">        :return: Estimated transaction fee in ICX (or LOOP if return_in_loop is True).</span>
<span class="sd">        :param use_hex_value: If True, returns a HexValue object instead of a raw balance.</span>

<span class="sd">        :rtype: Union[float, Decimal, int]</span>
<span class="sd">        :raises ValueError: If the payload is not properly formatted.</span>

<span class="sd">        Example usage:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                from pawnlib.uitils.http import IconRpcHelper</span>

<span class="sd">                # Initialize the helper</span>
<span class="sd">                icon_rpc_helper = IconRpcHelper(wallet=&quot;your_wallet_private_key&quot;)</span>

<span class="sd">                # Prepare transaction payload</span>
<span class="sd">                payload = {</span>
<span class="sd">                    &quot;from&quot;: &quot;hx123...&quot;,</span>
<span class="sd">                    &quot;to&quot;: &quot;hx456...&quot;,</span>
<span class="sd">                    &quot;value&quot;: &quot;0x1bc16d674ec80000&quot;,  # Example value in LOOP (1 ICX)</span>
<span class="sd">                    &quot;stepLimit&quot;: &quot;0xf4240&quot;</span>
<span class="sd">                }</span>

<span class="sd">                # Preview the transaction fee in ICX</span>
<span class="sd">                estimated_fee = icon_rpc_helper.preview_transaction_fee(payload, margin_steps=500, use_decimal=True)</span>
<span class="sd">                print(f&quot;Estimated Transaction Fee: {estimated_fee} ICX&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The payload must be a dictionary containing the transaction details.&quot;</span><span class="p">)</span>

        <span class="c1"># Estimate the step requirements</span>
        <span class="n">estimated_steps_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_estimate_step</span><span class="p">(</span><span class="n">tx</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="n">estimated_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">estimated_steps_hex</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Add margin to estimated steps</span>
        <span class="n">calculated_step_limit</span> <span class="o">=</span> <span class="n">estimated_steps</span> <span class="o">+</span> <span class="n">margin_steps</span>

        <span class="c1"># Fetch step price</span>
        <span class="n">step_price_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_price</span><span class="p">()</span>
        <span class="n">step_price</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_price_hex</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Calculate the transaction fee in LOOP</span>
        <span class="n">transaction_fee_loop</span> <span class="o">=</span> <span class="n">calculated_step_limit</span> <span class="o">*</span> <span class="n">step_price</span>

        <span class="c1"># If return_in_loop is True, return fee in LOOP (smallest unit)</span>
        <span class="k">if</span> <span class="n">return_in_loop</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">transaction_fee_loop</span>

        <span class="c1"># Otherwise, convert LOOP to ICX</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValue</span><span class="p">(</span><span class="n">transaction_fee_loop</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_decimal</span><span class="p">:</span>
            <span class="c1"># Convert LOOP to ICX using Decimal</span>
            <span class="n">transaction_fee_icx</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">transaction_fee_loop</span><span class="p">)</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e18&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert LOOP to ICX using float</span>
            <span class="n">transaction_fee_icx</span> <span class="o">=</span> <span class="n">transaction_fee_loop</span> <span class="o">/</span> <span class="mf">1e18</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated Transaction Fee: </span><span class="si">{</span><span class="n">transaction_fee_icx</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">transaction_fee_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transaction_fee_icx</span></div>


<div class="viewcode-block" id="IconRpcHelper.send_all_icx_with_decimal"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.send_all_icx_with_decimal">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_all_icx_with_decimal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_address</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer all available ICX from the wallet to the specified address, accounting for transaction fees.</span>

<span class="sd">        :param to_address: The recipient address where the ICX will be sent.</span>
<span class="sd">        :type to_address: str</span>
<span class="sd">        :param fee: Optional. The transaction fee in ICX. If not provided, it will be automatically calculated.</span>
<span class="sd">        :type fee: float or None</span>
<span class="sd">        :param step_limit: Optional. Custom step limit for the transaction. If not provided, it will be calculated.</span>
<span class="sd">        :type step_limit: int or None</span>
<span class="sd">        :param min_balance: Optional. The minimum balance to keep in the wallet after the transfer. Defaults to 0 ICX.</span>
<span class="sd">        :type min_balance: float</span>
<span class="sd">        :param margin_steps: The additional margin to apply to the estimated step limit. Defaults to 1000.</span>
<span class="sd">        :type margin_steps: int</span>
<span class="sd">        :return: None. Sends all available ICX except for the transaction fee and minimum balance.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        :raises ValueError: If the calculated transfer amount is less than or equal to zero.</span>
<span class="sd">        :raises Exception: If the transaction fails.</span>

<span class="sd">        Example usage:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                from pawnlib.utils.http import IconRpcHelper</span>

<span class="sd">                # Initialize the helper with the sender&#39;s wallet</span>
<span class="sd">                icon_rpc_helper = IconRpcHelper(wallet=&quot;your_wallet_private_key&quot;)</span>

<span class="sd">                # Transfer all ICX to the safety wallet</span>
<span class="sd">                icon_rpc_helper.send_all_icx(</span>
<span class="sd">                    to_address=&quot;hx8095412a43d07ed9869e55501c044849586ed671&quot;,</span>
<span class="sd">                    fee=0.00125,  # Optional fee</span>
<span class="sd">                    step_limit=100000,  # Optional step limit</span>
<span class="sd">                    min_balance=0,  # Keep minimum balance of 0 ICX</span>
<span class="sd">                    margin_steps=500  # Additional step margin for safety</span>
<span class="sd">                )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">from_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wallet_address</span><span class="p">()</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Starting ICX transfer from [bold]</span><span class="si">{</span><span class="n">from_address</span><span class="si">}</span><span class="s2">[/bold] to [bold]</span><span class="si">{</span><span class="n">to_address</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">)</span>

        <span class="n">balance_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">return_as_hex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">balance_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balance_hex</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">balance_icx</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">balance_loop</span><span class="p">)</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e18&#39;</span><span class="p">)</span>  <span class="c1"># Convert to ICX</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Sender Address: </span><span class="si">{</span><span class="n">from_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Current Balance: </span><span class="si">{</span><span class="n">balance_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">balance_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">from_address</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">to_address</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">estimated_fee_icx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_transaction_fee</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="n">margin_steps</span><span class="p">,</span> <span class="n">use_decimal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">transaction_fee_icx</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">fee</span><span class="p">)</span> <span class="k">if</span> <span class="n">fee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">estimated_fee_icx</span>
        <span class="n">transaction_fee_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transaction_fee_icx</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e18&#39;</span><span class="p">))</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Transaction Fee: </span><span class="si">{</span><span class="n">transaction_fee_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">transaction_fee_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>

        <span class="n">min_balance_icx</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">min_balance</span><span class="p">)</span>
        <span class="n">min_balance_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_balance_icx</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e18&#39;</span><span class="p">))</span>

        <span class="n">total_required_loop</span> <span class="o">=</span> <span class="n">transaction_fee_loop</span> <span class="o">+</span> <span class="n">min_balance_loop</span>
        <span class="n">total_required_icx</span> <span class="o">=</span> <span class="n">transaction_fee_icx</span> <span class="o">+</span> <span class="n">min_balance_icx</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Minimum Balance to Keep: </span><span class="si">{</span><span class="n">min_balance_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">min_balance_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Total Required (Fee + Min Balance): </span><span class="si">{</span><span class="n">total_required_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">total_required_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>

        <span class="n">transfer_amount_loop</span> <span class="o">=</span> <span class="n">balance_loop</span> <span class="o">-</span> <span class="n">total_required_loop</span>
        <span class="n">transfer_amount_icx</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">transfer_amount_loop</span><span class="p">)</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e18&#39;</span><span class="p">)</span>  <span class="c1"># Convert to ICX</span>

        <span class="k">if</span> <span class="n">transfer_amount_loop</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient balance to cover transaction fee and minimum balance. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">balance_icx</span><span class="si">}</span><span class="s2"> ICX, Required: </span><span class="si">{</span><span class="n">total_required_icx</span><span class="si">}</span><span class="s2"> ICX&quot;</span><span class="p">)</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Transfer Amount: </span><span class="si">{</span><span class="n">transfer_amount_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">transfer_amount_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>

        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">transfer_amount_loop</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Final Payload for Transaction: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_send</span><span class="p">()</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SUCCESS] Transaction sent successfully. TX Hash: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Transaction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">remaining_balance_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">return_as_hex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">remaining_balance_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remaining_balance_hex</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">remaining_balance_icx</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">remaining_balance_loop</span><span class="p">)</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;1e18&#39;</span><span class="p">)</span>  <span class="c1"># Convert to ICX</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Remaining Balance: </span><span class="si">{</span><span class="n">remaining_balance_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">remaining_balance_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remaining_balance_loop</span> <span class="o">&lt;=</span> <span class="n">min_balance_loop</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Remaining balance is within acceptable range.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[WARNING] Remaining balance is more than expected: </span><span class="si">{</span><span class="n">remaining_balance_icx</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">remaining_balance_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.send_all_icx"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.send_all_icx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_all_icx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_address</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer all available ICX from the wallet to the specified address, accounting for transaction fees.</span>
<span class="sd">        This version uses float instead of Decimal for comparison and calculations.</span>

<span class="sd">        :param to_address: The recipient address where the ICX will be sent.</span>
<span class="sd">        :type to_address: str</span>
<span class="sd">        :param fee: Optional. The transaction fee in ICX. If not provided, it will be automatically calculated.</span>
<span class="sd">        :type fee: float or None</span>
<span class="sd">        :param step_limit: Optional. Custom step limit for the transaction. If not provided, it will be calculated.</span>
<span class="sd">        :type step_limit: int or None</span>
<span class="sd">        :param min_balance: Optional. The minimum balance to keep in the wallet after the transfer. Defaults to 0 ICX.</span>
<span class="sd">        :type min_balance: float</span>
<span class="sd">        :param margin_steps: The additional margin to apply to the estimated step limit. Defaults to 0.</span>
<span class="sd">        :type margin_steps: int</span>
<span class="sd">        :return: None. Sends all available ICX except for the transaction fee and minimum balance.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        :raises ValueError: If the calculated transfer amount is less than or equal to zero.</span>
<span class="sd">        :raises Exception: If the transaction fails.</span>

<span class="sd">        Example usage:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                from pawnlib.utils.http import IconRpcHelper</span>

<span class="sd">                # Initialize the helper with the sender&#39;s wallet</span>
<span class="sd">                icon_rpc_helper = IconRpcHelper(wallet=&quot;your_wallet_private_key&quot;)</span>

<span class="sd">                # Transfer all ICX to the safety wallet</span>
<span class="sd">                icon_rpc_helper.send_all_icx_without_decimal(</span>
<span class="sd">                    to_address=&quot;hx8095412a43d07ed9869e55501c044849586ed671&quot;,</span>
<span class="sd">                    fee=0.00125,  # Optional fee</span>
<span class="sd">                    step_limit=100000,  # Optional step limit</span>
<span class="sd">                    min_balance=0,  # Keep minimum balance of 0 ICX</span>
<span class="sd">                    margin_steps=500  # Additional step margin for safety</span>
<span class="sd">                )</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">from_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wallet_address</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting ICX transfer from [bold]</span><span class="si">{</span><span class="n">from_address</span><span class="si">}</span><span class="s2">[/bold] to [bold]</span><span class="si">{</span><span class="n">to_address</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">)</span>
        <span class="n">balance_hex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">return_as_hex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">from_address</span><span class="si">}</span><span class="s2">&#39;s Balance: </span><span class="si">{</span><span class="n">balance_hex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prepare transaction payload</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">from_address</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">to_address</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">estimated_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_transaction_fee</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="n">margin_steps</span><span class="p">,</span> <span class="n">use_decimal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">transaction_fee</span> <span class="o">=</span> <span class="n">fee</span> <span class="k">if</span> <span class="n">fee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">estimated_fee</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction Fee: </span><span class="si">{</span><span class="n">transaction_fee</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>

        <span class="n">min_balance</span> <span class="o">=</span> <span class="n">HexValue</span><span class="p">(</span><span class="n">min_balance</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">ICX_IN_LOOP</span><span class="p">)</span>
        <span class="n">total_required</span> <span class="o">=</span> <span class="n">transaction_fee</span> <span class="o">+</span> <span class="n">min_balance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum Balance to Keep: </span><span class="si">{</span><span class="n">min_balance</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Required (Fee + Min Balance): </span><span class="si">{</span><span class="n">total_required</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate the transfer amount</span>
        <span class="n">transfer_amount</span> <span class="o">=</span> <span class="n">balance_hex</span>  <span class="o">-</span> <span class="n">total_required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transfer amount = </span><span class="si">{</span><span class="n">transfer_amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transfer_amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient balance to cover transaction fee and minimum balance. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">transfer_amount</span><span class="o">.</span><span class="n">tint</span><span class="si">}</span><span class="s2"> ICX, Required: </span><span class="si">{</span><span class="n">total_required</span><span class="o">.</span><span class="n">tint</span><span class="si">}</span><span class="s2"> ICX&quot;</span><span class="p">)</span>

        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transfer_amount</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Payload for Transaction: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;---- DRY-RUN----&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_send</span><span class="p">(</span><span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SUCCESS] Transaction sent successfully. TX Hash: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">remaining_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">return_as_hex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining Balance: </span><span class="si">{</span><span class="n">remaining_balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remaining_balance</span> <span class="o">&lt;=</span> <span class="n">min_balance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining balance is within acceptable range.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining balance is more than expected: </span><span class="si">{</span><span class="n">remaining_balance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.set_stake"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.set_stake">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_stake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_hex</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">ICX_IN_LOOP</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value provided for staking: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span>
        <span class="p">}</span>
        <span class="n">_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;setStake&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="n">is_wait</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">_response</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="IconRpcHelper.delegate_all_icx"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.delegate_all_icx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">delegate_all_icx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">stake_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stake</span><span class="p">(</span><span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">delegation_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_delegation</span><span class="p">(</span><span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bond_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bond</span><span class="p">(</span><span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">delegation_raw</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">delegation</span> <span class="ow">in</span>  <span class="n">delegation_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delegations&#39;</span><span class="p">):</span>
            <span class="n">delegation_raw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">delegation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">),</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">delegation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># print_var(delegation_raw)</span>
        <span class="n">total_voting</span> <span class="o">=</span> <span class="n">delegation_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalDelegated&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">bond_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalBonded&#39;</span><span class="p">)</span>
        <span class="n">available_delegation</span> <span class="o">=</span> <span class="n">stake_info</span> <span class="o">-</span> <span class="n">total_voting</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stake Amount    = </span><span class="si">{</span><span class="n">stake_info</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Delegated = </span><span class="si">{</span><span class="n">delegation_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalDelegated&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Bonded     = </span><span class="si">{</span><span class="n">bond_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalBonded&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Voted      = </span><span class="si">{</span><span class="n">total_voting</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available Delegation =  </span><span class="si">{</span><span class="n">available_delegation</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stake_info</span> <span class="o">==</span> <span class="n">total_voting</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already full delegation </span><span class="si">{</span><span class="n">stake_info</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">from_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wallet_address</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">from_address</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
                <span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;setDelegation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;delegations&quot;</span><span class="p">:</span> <span class="n">delegation_raw</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Use preview_transaction_fee to estimate the transaction fee</span>
        <span class="n">estimated_fee_icx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_transaction_fee</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="n">margin_steps</span><span class="p">,</span> <span class="n">use_decimal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">transaction_fee_icx</span> <span class="o">=</span> <span class="n">fee</span> <span class="k">if</span> <span class="n">fee</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">estimated_fee_icx</span>
        <span class="n">transaction_fee_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transaction_fee_icx</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">ICX_IN_LOOP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction Fee: </span><span class="si">{</span><span class="n">transaction_fee_icx</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">transaction_fee_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>


        <span class="n">min_balance_loop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_balance</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">ICX_IN_LOOP</span><span class="p">)</span>
        <span class="n">total_required_loop</span> <span class="o">=</span> <span class="n">transaction_fee_loop</span> <span class="o">+</span> <span class="n">min_balance_loop</span>
        <span class="n">total_required_icx</span> <span class="o">=</span> <span class="n">transaction_fee_icx</span> <span class="o">+</span> <span class="n">min_balance</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum Balance to Keep: </span><span class="si">{</span><span class="n">min_balance</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">min_balance_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Required (Fee + Min Balance): </span><span class="si">{</span><span class="n">total_required_icx</span><span class="si">}</span><span class="s2"> ICX (</span><span class="si">{</span><span class="n">total_required_loop</span><span class="si">}</span><span class="s2"> LOOP)&quot;</span><span class="p">)</span>

        <span class="n">delegation_amount_loop</span> <span class="o">=</span> <span class="n">stake_info</span><span class="o">.</span><span class="n">tint</span> <span class="o">-</span> <span class="n">total_required_loop</span>
        <span class="n">delegation_amount_icx</span> <span class="o">=</span> <span class="n">delegation_amount_loop</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">ICX_IN_LOOP</span>  <span class="c1"># Convert to ICX using float</span>

        <span class="n">delegated_difference_decimal</span>  <span class="o">=</span> <span class="n">stake_info</span><span class="o">.</span><span class="n">decimal</span> <span class="o">-</span> <span class="n">delegation_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalDelegated&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decimal</span> <span class="o">-</span> <span class="n">total_required_loop</span>
        <span class="n">delegated_difference_tint</span>  <span class="o">=</span> <span class="n">stake_info</span><span class="o">.</span><span class="n">tint</span> <span class="o">-</span> <span class="n">delegation_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;totalDelegated&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">tint</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diff : </span><span class="si">{</span><span class="n">delegated_difference_tint</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> ICX&quot;</span><span class="p">)</span>

        <span class="n">delegation_target_address</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">delegation_target_value</span> <span class="o">=</span> <span class="s2">&quot;0x0&quot;</span>
        <span class="n">print_var</span><span class="p">(</span><span class="n">delegation_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delegation_raw</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">delegation_raw</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">delegation_target_address</span> <span class="o">=</span> <span class="n">delegation_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
            <span class="n">delegation_target_value</span> <span class="o">=</span> <span class="n">HexValue</span><span class="p">(</span><span class="n">delegation_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>

        <span class="n">new_delegation</span> <span class="o">=</span> <span class="n">delegation_target_value</span> <span class="o">+</span> <span class="n">available_delegation</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New Delegation: </span><span class="si">{</span><span class="n">new_delegation</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;delegations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">delegation_target_address</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">new_delegation</span><span class="o">.</span><span class="n">hex</span><span class="p">}]</span>

        <span class="n">print_var</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_send</span><span class="p">()</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">))</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SUCCESS] Delegated </span><span class="si">{</span><span class="n">stake_info</span><span class="o">.</span><span class="n">tint</span><span class="si">}</span><span class="s2"> ICX successfully. TX Hash: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Staking transaction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">delegated_difference_decimal</span><span class="p">:</span>
            <span class="n">delegated_difference_hex</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">delegated_difference_decimal</span><span class="p">))</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">delegated_difference_tint</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> ICX, </span><span class="si">{</span><span class="n">delegated_difference_decimal</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">delegated_difference_hex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IconRpcHelper.stake_all_icx"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.IconRpcHelper.stake_all_icx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">stake_all_icx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fee</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_balance</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stake all available ICX, accounting for transaction fees, using float for calculations.</span>

<span class="sd">        :param to_address: The staking contract address where ICX will be staked.</span>
<span class="sd">        :type to_address: str</span>
<span class="sd">        :param fee: Optional. The transaction fee in ICX. If not provided, it will be automatically calculated.</span>
<span class="sd">        :type fee: float or None</span>
<span class="sd">        :param step_limit: Optional. Custom step limit for the transaction. If not provided, it will be calculated.</span>
<span class="sd">        :type step_limit: int or None</span>
<span class="sd">        :param min_balance: Optional. The minimum balance to keep in the wallet after the transfer. Defaults to 0 ICX.</span>
<span class="sd">        :type min_balance: float</span>
<span class="sd">        :param margin_steps: The additional margin to apply to the estimated step limit. Defaults to 1000.</span>
<span class="sd">        :type margin_steps: int</span>
<span class="sd">        :return: None. Stakes all available ICX except for the transaction fee and minimum balance.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        :raises ValueError: If the calculated staking amount is less than or equal to zero.</span>
<span class="sd">        :raises Exception: If the transaction fails.</span>

<span class="sd">        Example usage:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                from icon_rpc_helper import IconRpcHelper</span>

<span class="sd">                # Initialize the helper with the sender&#39;s wallet</span>
<span class="sd">                icon_rpc_helper = IconRpcHelper(wallet=&quot;your_wallet_private_key&quot;)</span>

<span class="sd">                # Stake all available ICX</span>
<span class="sd">                icon_rpc_helper.stake_all_available_icx(</span>
<span class="sd">                    to_address=&quot;hx8095412a43d07ed9869e55501c044849586ed671&quot;,</span>
<span class="sd">                    fee=0.00125,  # Optional fee</span>
<span class="sd">                    step_limit=100000,  # Optional step limit</span>
<span class="sd">                    min_balance=0,  # Keep minimum balance of 0 ICX</span>
<span class="sd">                    margin_steps=500  # Additional step margin for safety</span>
<span class="sd">                )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">current_staked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stake</span><span class="p">(</span><span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Current Balance: </span><span class="si">{</span><span class="n">current_balance</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Current Staked : </span><span class="si">{</span><span class="n">current_staked</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># If the current balance is equal to the current staked amount, no need to perform staking</span>
        <span class="k">if</span> <span class="n">current_balance</span> <span class="o">&lt;</span> <span class="mf">0.0017275</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] No difference between current balance and staked amount. Staking is not required.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Prepare a dummy transaction to estimate the transaction fee</span>
        <span class="n">from_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wallet_address</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json_rpc</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_sendTransaction&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">from_address</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
                <span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;setStake&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">current_staked</span><span class="o">.</span><span class="n">hex</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="c1"># Use preview_transaction_fee to estimate the transaction fee</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fee</span><span class="p">:</span>
            <span class="n">transaction_fee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preview_transaction_fee</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">margin_steps</span><span class="o">=</span><span class="n">margin_steps</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transaction_fee</span> <span class="o">=</span> <span class="n">HexTintValue</span><span class="p">(</span><span class="n">fee</span><span class="p">)</span>

        <span class="n">min_balance</span> <span class="o">=</span> <span class="n">HexTintValue</span><span class="p">(</span><span class="n">min_balance</span><span class="p">)</span>

        <span class="n">available_staking_amount</span> <span class="o">=</span> <span class="n">current_balance</span> <span class="o">-</span> <span class="n">transaction_fee</span> <span class="o">-</span> <span class="n">min_balance</span>
        <span class="n">final_staking_amount</span> <span class="o">=</span> <span class="n">available_staking_amount</span> <span class="o">+</span> <span class="n">current_staked</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction Fee:  </span><span class="si">{</span><span class="n">transaction_fee</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum Balance:  </span><span class="si">{</span><span class="n">min_balance</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Available Staking Amount :  </span><span class="si">{</span><span class="n">available_staking_amount</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Staking Amount:  </span><span class="si">{</span><span class="n">final_staking_amount</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;---- DRY-RUN----&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># If the staking amount is less than or equal to zero, raise an error</span>
        <span class="k">if</span> <span class="n">available_staking_amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient balance to cover transaction fee and minimum balance for staking. Balance: </span><span class="si">{</span><span class="n">current_balance</span><span class="o">.</span><span class="n">tint</span><span class="si">}</span><span class="s2"> ICX,&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot; Available Staking Amount: </span><span class="si">{</span><span class="n">available_staking_amount</span><span class="o">.</span><span class="n">tint</span><span class="si">}</span><span class="s2"> ICX&quot;</span><span class="p">)</span>

        <span class="c1"># Update the payload with the final staking amount</span>
        <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_staking_amount</span><span class="o">.</span><span class="n">hex</span>  <span class="c1"># Convert ICX to LOOP</span>

        <span class="c1"># Sign and send the staking transaction</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sign_tx</span><span class="p">(</span><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">step_limit</span><span class="o">=</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_send</span><span class="p">()</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SUCCESS] Staked </span><span class="si">{</span><span class="n">final_staking_amount</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2"> successfully. TX Hash: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Staking transaction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Check the updated stake after the transaction</span>
        <span class="n">updated_staked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stake</span><span class="p">(</span><span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">now_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">use_hex_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">staked_difference</span> <span class="o">=</span> <span class="n">updated_staked</span> <span class="o">-</span> <span class="n">current_staked</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Updated Staked Amount: </span><span class="si">{</span><span class="n">updated_staked</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">, now_balance=</span><span class="si">{</span><span class="n">now_balance</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📈 [INFO] Staked increase: </span><span class="si">{</span><span class="n">staked_difference</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">staked_difference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔼 Increased staking by: </span><span class="si">{</span><span class="n">staked_difference</span><span class="o">.</span><span class="n">output</span><span class="p">()</span><span class="si">}</span><span class="s2"> 🎉&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">staked_difference</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🔽 Decreased staking by: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">staked_difference</span><span class="o">.</span><span class="n">tint</span><span class="p">)</span><span class="si">:</span><span class="s2">.18f</span><span class="si">}</span><span class="s2"> ICX ⚠️&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;🟡 No change in staked amount.&quot;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="JsonRequest"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.JsonRequest">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">JsonRequest</span><span class="p">:</span>
<div class="viewcode-block" id="JsonRequest.__init__"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.JsonRequest.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: It will be generated the JSON or JSON-RPC request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="disable_ssl_warnings"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.disable_ssl_warnings">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">disable_ssl_warnings</span><span class="p">():</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">urllib3.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InsecureRequestWarning</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">InsecureRequestWarning</span><span class="p">)</span></div>


<div class="viewcode-block" id="append_scheme"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.append_scheme">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">append_scheme</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default_scheme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Appends the specified scheme (e.g., http, https) to the URL if it is missing.</span>

<span class="sd">    :param url: The URL to validate and modify.</span>
<span class="sd">    :param default_scheme: The scheme to prepend if missing. Default is &quot;http&quot;.</span>
<span class="sd">    :return: A URL with a scheme.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="c1"># Check if the URL starts with a valid scheme</span>
    <span class="k">if</span> <span class="s2">&quot;://&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">default_scheme</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Return the original URL if scheme exists</span>
    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="append_http"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.append_http">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">append_http</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Add http:// if it doesn&#39;t exist in the URL</span>

<span class="sd">    :param url:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">)):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="append_s3"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.append_s3">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">append_s3</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Add http:// if it doesn&#39;t exist in the URL</span>

<span class="sd">    :param url:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="append_ws"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.append_ws">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">append_ws</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Add ws:// if it doesn&#39;t exist in the URL</span>

<span class="sd">    :param url:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">url</span>  <span class="c1"># 또는 오류 처리, 예: raise ValueError(&quot;URL cannot be empty&quot;)</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">,</span> <span class="s2">&quot;wss://&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;ws://&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ws://&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;wss://&quot;</span><span class="p">)):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ws://</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="append_api_v3"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.append_api_v3">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">append_api_v3</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;/api/v3&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/api/v3&quot;</span>
    <span class="k">return</span> <span class="n">append_http</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_http"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.remove_http">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">remove_http</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove the r&#39;https?://&#39; string</span>

<span class="sd">    :param url:</span>
<span class="sd">    :return:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https?://&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_operator_truth"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.get_operator_truth">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">get_operator_truth</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">relate</span><span class="p">,</span> <span class="n">cut</span><span class="p">):</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="n">_operator</span><span class="o">.</span><span class="n">gt</span><span class="p">,</span>
        <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="n">_operator</span><span class="o">.</span><span class="n">lt</span><span class="p">,</span>
        <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="n">_operator</span><span class="o">.</span><span class="n">ge</span><span class="p">,</span>
        <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="n">_operator</span><span class="o">.</span><span class="n">le</span><span class="p">,</span>
        <span class="s1">&#39;==&#39;</span><span class="p">:</span> <span class="n">_operator</span><span class="o">.</span><span class="n">eq</span><span class="p">,</span>
        <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="n">_operator</span><span class="o">.</span><span class="n">ne</span><span class="p">,</span>
        <span class="s1">&#39;include&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">y</span><span class="p">,</span>
        <span class="s1">&#39;exclude&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">y</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ops</span><span class="p">[</span><span class="n">relate</span><span class="p">](</span><span class="n">inp</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span></div>


<div class="viewcode-block" id="guess_key"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.guess_key">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">guess_key</span><span class="p">(</span><span class="n">find_key</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">guessed_result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">find_key</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">guessed_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">find_key</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">guessed_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">guessed_result</span></div>


<div class="viewcode-block" id="SuccessCriteria"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.SuccessCriteria">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">SuccessCriteria</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="s2">&quot;exclude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">expected</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="c1"># operator: Literal[tuple(ALLOW_OPERATOR)] = &quot;&quot;</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">target</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_string_valid_type</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">get_operator_truth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="p">)</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_operator_truth(target=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="si">}</span><span class="s2">, expected=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expected</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_string_valid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">_debug_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;expected&quot;</span><span class="p">]:</span>
            <span class="n">_attr_value_in_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="s2">&quot;__NOT_NONE__&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_attr_value_in_class</span> <span class="o">!=</span> <span class="s2">&quot;__NOT_NONE__&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_attr_value_in_class</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">_attr_value_in_class</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">_attr_value_in_class</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">is_float</span><span class="p">(</span><span class="n">_attr_value_in_class</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">_attr_value_in_class</span><span class="p">))</span>

                <span class="n">_modified_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>
                <span class="n">_debug_message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">_modified_value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">_modified_value</span><span class="p">)</span><span class="si">}</span><span class="s2">) , &quot;</span>

        <span class="c1"># pawn.console.debug(_debug_message)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;SuccessCriteria </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;SuccessCriteria </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

<div class="viewcode-block" id="SuccessCriteria.to_dict"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.SuccessCriteria.to_dict">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span></div></div>


<div class="viewcode-block" id="SuccessResponse"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.SuccessResponse">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">SuccessResponse</span><span class="p">(</span><span class="n">SuccessCriteria</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">target_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">operator</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;include&quot;</span><span class="p">,</span> <span class="s2">&quot;exclude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">expected</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">target</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">):</span>
        <span class="c1"># if not target or not operator or not expected or target_key:</span>
        <span class="c1">#     raise ValueError(f&quot;target: {target}, operator: {operator}, expected: {expected}, target_key: {target_key} &quot;)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]&lt;Error&gt;[/red] &#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39; is not dict&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target is not dict - &#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span> <span class="o">=</span> <span class="n">target_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">FlatDict</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="n">_selected_flatten_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">_selected_flatten_target</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_selected_flatten_target</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]&lt;SuccessCriteria Error&gt;[/red] &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="si">}</span><span class="s2">&#39; is not attribute in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[red]&lt;SuccessCriteria Error&gt;[/red] &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="si">}</span><span class="s2">&#39; not found. </span><span class="se">\n</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Did you mean </span><span class="si">{</span><span class="n">guess_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> ?&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="CallHttp"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CallHttp</span><span class="p">:</span>
    <span class="n">SHORTEN_MESSAGE_DICT</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Timeout Error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;params_message&quot;</span><span class="p">:</span> <span class="s2">&quot;timeout=</span><span class="si">{}</span><span class="s2">&quot;</span>
        <span class="p">},</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span> <span class="s2">&quot;HTTP Error&quot;</span><span class="p">,</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span> <span class="s2">&quot;DNS lookup Error&quot;</span><span class="p">,</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span> <span class="s2">&quot;OOps: Something Else&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span>
            <span class="c1"># method: Literal[AllowsHttpMethod.get] = &quot;get&quot;,</span>
            <span class="c1"># method: AllowsHttpMethod = AllowsHttpMethod.get,</span>
            <span class="c1"># method: Literal[tuple(method for method in AllowsHttpMethod)],</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
            <span class="n">ignore_ssl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">success_criteria</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;__DEFAULT__&quot;</span><span class="p">,</span>
            <span class="n">success_operator</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span>
            <span class="n">success_syntax</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;operator&quot;</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
            <span class="n">raise_on_failure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>

            <span class="n">auto_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ssl</span> <span class="o">=</span> <span class="n">ignore_ssl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="n">verify</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ssl</span><span class="p">:</span>
            <span class="n">disable_ssl_warnings</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="n">_default_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">AllowsKey</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="mi">399</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">success_criteria</span> <span class="o">==</span> <span class="s1">&#39;__DEFAULT__&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="n">_default_criteria</span>
        <span class="k">elif</span> <span class="n">success_criteria</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="n">success_criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">success_operator</span> <span class="o">=</span> <span class="n">success_operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success_syntax</span> <span class="o">=</span> <span class="n">success_syntax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_failure</span> <span class="o">=</span> <span class="n">raise_on_failure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DEFAULT_UA</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CallHttp Agent/</span><span class="si">{</span><span class="n">pawn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PAWN_VERSION&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># self.response = requests.models.Response()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_response</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_success_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_success_criteria</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># self.run()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_shorten_exception_message_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="n">default_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(url=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2"> method=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">req_exception</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHORTEN_MESSAGE_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">req_exception</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">):</span>
                    <span class="n">_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
                    <span class="n">_params_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params_message&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
                    <span class="n">_params_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_message</span><span class="si">}{</span><span class="n">default_msg</span><span class="si">}{</span><span class="n">_params_message</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;Unknown Error&gt;</span><span class="si">{</span><span class="n">default_msg</span><span class="si">}</span><span class="s2">)&quot;</span>

<div class="viewcode-block" id="CallHttp.exit_on_failure"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.exit_on_failure">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">exit_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">999</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_shorten_exception_message_handler</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span> <span class="n">elapsed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raise_on_failure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoTraceBackException</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red][FAIL][/red] </span><span class="si">{</span><span class="n">exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># self.response.status_code = 999</span>
            <span class="c1"># self.response.success = False</span>
            <span class="c1"># self.response.error = self._shorten_exception_message_handler(exception)</span>
            <span class="c1"># print(self.timing)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span></div>

<div class="viewcode-block" id="CallHttp.run"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_response</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_criteria</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_success</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_success</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

<div class="viewcode-block" id="CallHttp.get_response"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.get_response">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HttpResponse</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span></div>

<div class="viewcode-block" id="CallHttp.print_http_response"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.print_http_response">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_http_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">):</span>
            <span class="n">response_type</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_type</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response from &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; 👉 </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">response_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;rule.line&quot;</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="n">characters</span><span class="o">=</span><span class="s2">&quot;═&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">print_json</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_syntax</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;one-dark&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CallHttp.fetch_response"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.fetch_response">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">(</span><span class="n">json_response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">http_version</span><span class="p">,</span> <span class="n">r_headers</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="o">=</span> <span class="p">({},</span> <span class="p">{},</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">):</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported method=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;, url=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported method=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2">, url=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_payload_string</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_payload_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span>

            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TRY] url=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">, method=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, kwargs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PAWN_DEBUG&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">:</span>
                <span class="n">print_json</span><span class="p">(</span><span class="n">_payload_string</span><span class="p">)</span>

            <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exit_on_failure</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">timing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_elapsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing</span><span class="p">:</span>
                <span class="n">_elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">_elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">response_time</span> <span class="o">=</span> <span class="n">_elapsed</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">version</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_error</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span>

<div class="viewcode-block" id="CallHttp.fetch_criteria"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.fetch_criteria">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">success_criteria</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">success_operator</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;and&quot;</span><span class="p">,</span> <span class="s2">&quot;or&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span>
                       <span class="p">):</span>
        <span class="n">_response_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">success_criteria</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="n">success_criteria</span>
        <span class="k">if</span> <span class="n">success_operator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_operator</span> <span class="o">=</span> <span class="n">success_operator</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;passing success_criteria&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_syntax</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_syntax</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="n">_check_syntax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_criteria_syntax</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">_check_syntax</span><span class="p">:</span>
                    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[blue]Try to convert[/blue] </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">)</span><span class="si">}</span><span class="s2">, _check_criteria_syntax=</span><span class="si">{</span><span class="n">_check_syntax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_recursive_convert_criteria</span><span class="p">()</span>

            <span class="n">depth</span> <span class="o">=</span> <span class="n">list_depth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">criteria</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">:</span>
                <span class="c1"># pawn.console.debug(f&quot;Compare Criteria =&gt; {type(criteria)} {criteria}&quot;)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">_criteria</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
                    <span class="n">_criteria</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_response_dict</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pconf</span><span class="p">()</span><span class="o">.</span><span class="n">PAWN_DEBUG</span><span class="p">:</span>
                        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_criteria</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_success_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SuccessResponse</span><span class="p">(</span><span class="o">*</span><span class="n">_criteria</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">criteria</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_response_dict</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_success_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SuccessResponse</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">))</span></div>
            <span class="c1"># pawn.console.log(self._success_results)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_operator</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">ALLOW_OPERATOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_criteria_syntax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_operator</span><span class="p">(</span><span class="n">criteria</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">criteria</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_criteria_syntax</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_recursive_convert_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">string_criteria</span><span class="p">:</span>
            <span class="n">string_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span>

        <span class="k">if</span> <span class="n">string_criteria</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string_criteria</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_criteria</span><span class="p">(</span><span class="n">string_criteria</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">string_criteria_in_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">string_criteria</span> <span class="ow">in</span> <span class="n">string_criteria</span><span class="p">:</span>
                <span class="n">converted_criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recursive_convert_criteria</span><span class="p">(</span><span class="n">string_criteria</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">converted_criteria</span><span class="p">:</span>
                    <span class="n">string_criteria_in_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">converted_criteria</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">string_criteria_in_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">success_criteria</span> <span class="o">=</span> <span class="n">string_criteria_in_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">ALLOW_OPERATOR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">argument</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">operator</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">ALLOW_OPERATOR</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;=&#39;</span><span class="p">]):</span>
                    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Invalid operator - &#39;</span><span class="si">{</span><span class="n">argument</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid operator - &#39;</span><span class="si">{</span><span class="n">argument</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">operator</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_list_criteria</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_criteria</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">criteria</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">criteria</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="CallHttp.is_success"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallHttp.is_success">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_success</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">expected_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_success_results</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_success_results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_success_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_result</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                    <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_operator</span> <span class="o">==</span> <span class="s2">&quot;and&quot;</span> <span class="ow">and</span> <span class="n">success_count</span> <span class="o">==</span> <span class="n">expected_count</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_operator</span> <span class="o">==</span> <span class="s2">&quot;or&quot;</span> <span class="ow">and</span> <span class="n">success_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="HttpInspect"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">HttpInspect</span><span class="p">:</span>
<div class="viewcode-block" id="HttpInspect.__init__"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_redirects</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                 <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_response_length</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dns_server</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the HttpInspect class for HTTP request inspection.</span>

<span class="sd">        This class provides functionality to inspect HTTP requests and responses,</span>
<span class="sd">        including DNS resolution, timing analysis, and response handling.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str): The target URL to inspect. Will be prefixed with &#39;http://&#39; if no scheme is provided.</span>
<span class="sd">            method (str, optional): HTTP method to use. Defaults to &#39;GET&#39;.</span>
<span class="sd">            headers (dict, optional): Custom HTTP headers. Defaults to None.</span>
<span class="sd">            auth (tuple, optional): Authentication credentials. Defaults to None.</span>
<span class="sd">            timeout (int, optional): Request timeout in seconds. Defaults to 10.</span>
<span class="sd">            max_redirects (int, optional): Maximum number of redirects to follow. Defaults to 5.</span>
<span class="sd">            verify (bool, optional): Whether to verify SSL certificates. Defaults to True.</span>
<span class="sd">            data (dict, optional): Request body data. Defaults to None.</span>
<span class="sd">            max_response_length (int, optional): Maximum length of response to display. Defaults to 700.</span>
<span class="sd">            output (str, optional): Output format specification. Defaults to None.</span>
<span class="sd">            dns_server (str, optional): DNS server to use. Defaults to None.</span>
<span class="sd">            debug (bool, optional): Whether to enable debug mode. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers_provided</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span> <span class="o">=</span> <span class="n">max_redirects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="n">verify</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">Console</span><span class="p">()</span>
                    
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span> <span class="ow">or</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">port</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">443</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;https&#39;</span> <span class="k">else</span> <span class="mi">80</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">=</span> <span class="n">max_response_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterfall_timings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dns_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span> <span class="o">=</span> <span class="n">dns_server</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_init_settings</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize the URL to ensure it is always in a valid format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;URL cannot be empty&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="s1">&#39;https://&#39;</span><span class="p">)):</span>            
            <span class="k">if</span> <span class="s1">&#39;:443&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;https://</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;http://</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_init_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logs the initial settings to the log.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]URL:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]Method:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]Domain:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]Timeout:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]Max Redirects:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;[bold]DNS Server:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;System Default&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;HttpInspect Configuration&quot;</span><span class="p">,</span> 
                <span class="n">expand</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">))</span>

<div class="viewcode-block" id="HttpInspect.get_ip_address"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.get_ip_address">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the IP address of the specified domain.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            domain (str, optional): The domain name to lookup. Defaults to the domain extracted from the current URL.</span>
<span class="sd">            url (str, optional): The URL to include in timing information. Defaults to the current URL.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: The resolved IP address or None if lookup fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Host&#39;</span><span class="p">):</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Host&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>

        <span class="n">ip_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.)</span><span class="si">{3}</span><span class="s1">(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$&#39;</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ip_pattern</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dns_cache</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">domain</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_timing_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dns_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Using provided IP </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">domain</span>

        <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_cache</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span><span class="p">:</span>                
                <span class="n">resolver</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">Resolver</span><span class="p">()</span>
                <span class="n">resolver</span><span class="o">.</span><span class="n">nameservers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span><span class="p">]</span>
                <span class="n">answers</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>            
                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

            <span class="n">dns_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms로 변환</span>
                        
            <span class="bp">self</span><span class="o">.</span><span class="n">dns_cache</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_timing_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">dns_time</span><span class="o">=</span><span class="n">dns_time</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Resolved </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DNS 조회: </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">dns_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            
        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NXDOMAIN</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NoAnswer</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error:[/] Could not resolve IP for </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Unexpected error during DNS resolution:[/] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_timing_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dns_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tcp_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
                         <span class="n">tls_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ttfb_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
                         <span class="n">status</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">http_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add waterfall timing information.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterfall_timings</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s1">&#39;dns_time&#39;</span><span class="p">:</span> <span class="n">dns_time</span><span class="p">,</span>
            <span class="s1">&#39;tcp_time&#39;</span><span class="p">:</span> <span class="n">tcp_time</span><span class="p">,</span>
            <span class="s1">&#39;tls_time&#39;</span><span class="p">:</span> <span class="n">tls_time</span><span class="p">,</span>
            <span class="s1">&#39;ttfb_time&#39;</span><span class="p">:</span> <span class="n">ttfb_time</span><span class="p">,</span>
            <span class="s1">&#39;total_time&#39;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s1">&#39;http_version&#39;</span><span class="p">:</span> <span class="n">http_version</span><span class="p">,</span>
            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
            <span class="s1">&#39;real_url&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># 응답 수신 후 업데이트됨</span>
        <span class="p">})</span>

<div class="viewcode-block" id="HttpInspect.get_dns_records"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.get_dns_records">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_dns_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">record_types</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the DNS records for the specified domain.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            domain (str): The domain name to lookup.</span>
<span class="sd">            record_types (List[str], optional): The list of record types to lookup. Defaults to A, AAAA, CNAME, MX, TXT, NS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">record_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">record_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;AAAA&quot;</span><span class="p">,</span> <span class="s2">&quot;CNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;MX&quot;</span><span class="p">,</span> <span class="s2">&quot;TXT&quot;</span><span class="p">,</span> <span class="s2">&quot;NS&quot;</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">resolver</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">Resolver</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span><span class="p">:</span>
            <span class="n">resolver</span><span class="o">.</span><span class="n">nameservers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">rtype</span> <span class="ow">in</span> <span class="n">record_types</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">answers</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">lifetime</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">to_text</span><span class="p">())</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">]</span>
                
                <span class="c1"># A 레코드인 경우 첫 번째 IP를 기본 IP로 설정</span>
                <span class="k">if</span> <span class="n">rtype</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="ow">and</span> <span class="n">answers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_text</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dns_cache</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
                    
            <span class="k">except</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NoAnswer</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NXDOMAIN</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NoNameservers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Error getting </span><span class="si">{</span><span class="n">rtype</span><span class="si">}</span><span class="s2"> records for </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">:[/] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="p">[</span><span class="n">rtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="HttpInspect.make_http_request"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.make_http_request">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">make_http_request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform an HTTP request and analyze the response.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the request was successful</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Pawnlib-HttpInspect/</span><span class="si">{</span><span class="n">pawn</span><span class="o">.</span><span class="n">version_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not get IP address&quot;</span><span class="p">)</span>

            <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_server</span><span class="p">:</span>
                <span class="n">connect_url</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">copy_with</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">host</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[cyan]Connected URL: </span><span class="si">{</span><span class="n">connect_url</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>            
                <span class="n">connect_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
    
            <span class="k">def</span><span class="w"> </span><span class="nf">on_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                <span class="n">request</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">parsed_request_url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
                <span class="n">request_domain</span> <span class="o">=</span> <span class="n">parsed_request_url</span><span class="o">.</span><span class="n">host</span>

                <span class="k">if</span> <span class="n">request_domain</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[cyan]Request URL: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[cyan]Request Headers: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">on_response</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                
                <span class="n">parsed_response_url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">parsed_response_url</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">:</span>
                    <span class="n">domain_url</span> <span class="o">=</span> <span class="n">parsed_response_url</span><span class="o">.</span><span class="n">copy_with</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">domain_url</span> <span class="o">=</span> <span class="n">parsed_response_url</span>
                
                <span class="n">total_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms</span>
                <span class="n">ttfb_time</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">elapsed</span> <span class="k">else</span> <span class="mi">0</span>
                
                <span class="n">connect_phase</span> <span class="o">=</span> <span class="n">total_time</span> <span class="o">-</span> <span class="n">ttfb_time</span>
                <span class="n">tcp_time</span> <span class="o">=</span> <span class="n">connect_phase</span> <span class="o">*</span> <span class="mf">0.6</span>  <span class="c1"># TCP connection is estimated to be 60% of the connection phase </span>
                <span class="n">tls_time</span> <span class="o">=</span> <span class="n">connect_phase</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># HTTPS is 40% of the connection phase</span>

                <span class="n">match_found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">timing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterfall_timings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">domain_url</span><span class="p">)</span> <span class="ow">and</span> <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">timing</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                            <span class="s1">&#39;real_url&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">),</span>
                            <span class="s1">&#39;http_version&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;HTTP/&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;tcp_time&#39;</span><span class="p">:</span> <span class="n">tcp_time</span><span class="p">,</span>
                            <span class="s1">&#39;tls_time&#39;</span><span class="p">:</span> <span class="n">tls_time</span><span class="p">,</span>
                            <span class="s1">&#39;ttfb_time&#39;</span><span class="p">:</span> <span class="n">ttfb_time</span><span class="p">,</span>
                            <span class="s1">&#39;total_time&#39;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
                            <span class="s1">&#39;details&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="p">})</span>
                        <span class="n">match_found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">+=</span> <span class="n">total_time</span>
                        <span class="k">break</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match_found</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_timing_info</span><span class="p">(</span>
                        <span class="n">url</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">domain_url</span><span class="p">),</span>
                        <span class="n">dns_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># DNS is already completed</span>
                        <span class="n">tcp_time</span><span class="o">=</span><span class="n">tcp_time</span><span class="p">,</span>
                        <span class="n">tls_time</span><span class="o">=</span><span class="n">tls_time</span><span class="p">,</span>
                        <span class="n">ttfb_time</span><span class="o">=</span><span class="n">ttfb_time</span><span class="p">,</span>
                        <span class="n">total_time</span><span class="o">=</span><span class="n">total_time</span><span class="p">,</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                        <span class="n">http_version</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;HTTP/&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">),</span>
                        <span class="n">details</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s1">)&#39;</span>
                        
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">+=</span> <span class="n">total_time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">waterfall_timings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;real_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
                <span class="n">follow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">verify</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">auth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
                <span class="n">max_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span><span class="p">,</span>
                <span class="n">event_hooks</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">on_request</span><span class="p">],</span>
                    <span class="s1">&#39;response&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">on_response</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">connect_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">connect_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> 
                                               <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PUT&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">connect_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                              <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">connect_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">connect_url</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">connect_url</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">connect_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                                <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">connect_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>                
                <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms</span>
                
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">RequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Request Error:[/] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Request Failed&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Value Error:[/] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Request Failed&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold red]Unexpected Error:[/] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Request Failed&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_status_emoji</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;상태 코드에 맞는 이모지를 반환합니다.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># 정보</span>
            <span class="k">return</span> <span class="s2">&quot;🕑&quot;</span>
        <span class="k">if</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>  <span class="c1"># 성공</span>
            <span class="k">return</span> <span class="s2">&quot;✅&quot;</span>
        <span class="k">if</span> <span class="mi">300</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">:</span>  <span class="c1"># 리다이렉션</span>
            <span class="k">return</span> <span class="s2">&quot;↪️&quot;</span>
        <span class="k">if</span> <span class="mi">400</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>  <span class="c1"># 클라이언트 오류</span>
            <span class="k">return</span> <span class="s2">&quot;⚠️&quot;</span>
        <span class="k">if</span> <span class="mi">500</span> <span class="o">&lt;=</span> <span class="n">code</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">:</span>  <span class="c1"># 서버 오류</span>
            <span class="k">return</span> <span class="s2">&quot;💥&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;❓&quot;</span>  <span class="c1"># 알 수 없는 상태</span>

<div class="viewcode-block" id="HttpInspect.display_results"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.display_results">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">display_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HTTP 요청 결과를 표시합니다.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="s2">&quot;[bold red]Error: No response received&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Request Failed&quot;</span><span class="p">))</span>
            <span class="k">return</span>
    
        <span class="n">status_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">status_style</span> <span class="o">=</span> <span class="s2">&quot;bold green&quot;</span>
        <span class="k">elif</span> <span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
            <span class="n">status_style</span> <span class="o">=</span> <span class="s2">&quot;bold yellow&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_style</span> <span class="o">=</span> <span class="s2">&quot;bold red&quot;</span>
            
        <span class="n">emoji</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_emoji</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold green]HTTP </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> Request:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[bold cyan]HTTP Version:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[bold cyan]Server IP:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">status_style</span><span class="si">}</span><span class="s2">]Status Code:[/] </span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">reason_phrase</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;[bold cyan]Final URL:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># f&quot;[bold cyan]Elapsed Time:[/] {self.elapsed_time:.2f} ms&quot;,</span>
            <span class="sa">f</span><span class="s2">&quot;[bold cyan]Elapsed Time:[/] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Request Info&quot;</span>
        <span class="p">))</span>
        
        <span class="n">waterfall</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Waterfall Timing&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;dim&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;HTTP&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;DNS (ms)&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;TCP (ms)&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;TLS (ms)&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;TTFB (ms)&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Total (ms)&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;red bold&quot;</span><span class="p">)</span>
        <span class="n">waterfall</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;URL&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">)</span>

        <span class="n">ordered_timings</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">history</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">timing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterfall_timings</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;real_url&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">url</span><span class="p">)</span> <span class="ow">and</span> <span class="n">timing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">:</span>
                    <span class="n">ordered_timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timing</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">timing</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ordered_timings</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">status_emoji</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_emoji</span><span class="p">(</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span>
            <span class="n">status_style</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="k">if</span> <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">400</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
            
            <span class="n">waterfall</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">status_style</span><span class="si">}</span><span class="s2">]</span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status_emoji</span><span class="si">}</span><span class="s2">[/</span><span class="si">{</span><span class="n">status_style</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;http_version&#39;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;dns_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;tcp_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;tls_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;ttfb_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timing</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">timing</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">waterfall</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers_provided</span><span class="p">:</span>
            <span class="n">req_header_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Request Headers&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">req_header_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Header&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">req_header_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">req_header_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">req_header_table</span><span class="p">)</span>

        <span class="n">res_header_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;📦 Response Headers&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res_header_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Header&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res_header_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">res_header_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">res_header_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_response_body</span><span class="p">()</span></div>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_response_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the response body in the appropriate format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">should_skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">should_skip</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">response_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">response_detail_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> | Reason: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">reason_phrase</span><span class="si">}</span><span class="s2"> | Size: </span><span class="si">{</span><span class="n">convert_bytes</span><span class="p">(</span><span class="n">response_size</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                
        <span class="k">if</span> <span class="s2">&quot;application/json&quot;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">formatted</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">formatted</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">formatted</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">... (truncated)&quot;</span>

                <span class="n">syntax</span> <span class="o">=</span> <span class="n">Syntax</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;monokai&quot;</span><span class="p">,</span> <span class="n">line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">word_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">syntax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;🧾 Response Body (JSON) </span><span class="si">{</span><span class="n">response_detail_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Warning: JSON parsing failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_display_text_response</span><span class="p">()</span>
        
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">content_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="s2">&quot;application/xml&quot;</span><span class="p">,</span> <span class="s2">&quot;text/xml&quot;</span><span class="p">]):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">... (truncated)&quot;</span>
                
            <span class="n">syntax</span> <span class="o">=</span> <span class="n">Syntax</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s2">&quot;monokai&quot;</span><span class="p">,</span> <span class="n">line_numbers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">word_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">syntax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;🧾 Response Body (</span><span class="si">{</span><span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">response_detail_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_text_response</span><span class="p">()</span>
        

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold green]🧾 Response saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span>
            
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_text_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display a plain text response.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
            
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">... (truncated)&quot;</span>
            
        <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;🧾 Response Body (</span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<div class="viewcode-block" id="HttpInspect.display_dns_records"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.display_dns_records">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">display_dns_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the DNS records.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_dns_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
        
        <span class="n">dns_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;DNS Records for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dns_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span> <span class="n">no_wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dns_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">overflow</span><span class="o">=</span><span class="s2">&quot;fold&quot;</span><span class="p">)</span>
        
        <span class="n">has_records</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">records</span><span class="p">:</span>
                <span class="n">has_records</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">dns_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>
                
        <span class="k">if</span> <span class="n">has_records</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">dns_table</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[yellow]No DNS records found[/yellow]&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HttpInspect.export_results"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.export_results">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">export_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Export the results to a file.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            format (str): The format to export (&#39;json&#39;, &#39;text&#39;)</span>
<span class="sd">            filename (str, optional): The file name. Defaults to &#39;{domain}_results.{format}&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[yellow]Warning: No results to export[/yellow]&quot;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">_results.</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="n">result_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span>
            <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
            <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">,</span>
            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
            <span class="s2">&quot;dns_records&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_records</span><span class="p">,</span>
            <span class="s2">&quot;waterfall_timings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterfall_timings</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="nb">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># text</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IP: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Status Code: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elapsed Time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ms</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Headers:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Body:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold green]Results exported to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HttpInspect.run"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.HttpInspect.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;전체 검사 프로세스를 실행합니다.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">Panel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold]HTTP Inspection: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">[/]&quot;</span><span class="p">,</span> 
                                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;bold blue&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold red]Aborting: Failed to resolve domain[/]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
                    
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_http_request</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[bold red]Aborting: HTTP request failed[/]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">get_dns_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">display_results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_dns_records</span><span class="p">()</span>           
        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="parse_auth"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.parse_auth">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">parse_auth</span><span class="p">(</span><span class="n">auth_str</span><span class="p">):</span>    
    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">auth_str</span><span class="p">:</span>
        <span class="c1"># Basic Auth</span>
        <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">auth_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># OAuth 토큰 (Bearer)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">auth_str</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span></div>

<div class="viewcode-block" id="parse_headers"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.parse_headers">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">parse_headers</span><span class="p">(</span><span class="n">headers_str</span><span class="p">):</span>    
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headers_str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers_str</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers_str</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">headers</span></div>


<div class="viewcode-block" id="CheckSSL"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CheckSSL">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CheckSSL</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SSL Certificate Checker.</span>

<span class="sd">    This class is responsible for checking the SSL certificate of a given host.</span>
<span class="sd">    It retrieves SSL certificate information, checks its expiry status, and displays</span>
<span class="sd">    the relevant details in a formatted table.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        host (str): The hostname of the server to check.</span>
<span class="sd">        port (int): The port number to connect to (default is 443).</span>
<span class="sd">        timeout (float): The timeout for the connection in seconds (default is 5.0).</span>
<span class="sd">        sni_hostname (str): The hostname to use for the SNI (Server Name Indication) handshake.</span>
<span class="sd">        ssl_info (dict): Stores the SSL certificate information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">sni_hostname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        

        <span class="n">proper_url</span> <span class="o">=</span> <span class="n">append_scheme</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">)</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">proper_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span>  <span class="c1"># &quot;httpbin.org&quot;가 추출됨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sni_hostname</span> <span class="o">=</span> <span class="n">sni_hostname</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[cyan]Checking SSL certificate for TCP </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="si">}</span><span class="s2"> [/cyan]&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(SNI=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sni_hostname</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CheckSSL.get_ssl"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CheckSSL.get_ssl">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_ssl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the SSL certificate for the specified host.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The SSL certificate information.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SystemExit: If there is a connection error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sni_hostname</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">getpeercert</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red]Connect SSL Error: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">&#39; -&gt; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">[/red]&quot;</span><span class="p">)</span></div>
            <span class="c1"># sys.exit(1)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse SSL date format.</span>

<span class="sd">        Args:</span>
<span class="sd">            date_str (str): The date string to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datetime: The parsed date.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="s1">&#39;%b </span><span class="si">%d</span><span class="s1"> %H:%M:%S %Y %Z&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="CheckSSL.check_expiry"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CheckSSL.check_expiry">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_expiry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the expiry status of the SSL certificate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A status string and the number of days left until expiry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">not_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notAfter&#39;</span><span class="p">))</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">not_after</span> <span class="o">-</span> <span class="n">now</span>
        <span class="n">days_left</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span>
        <span class="k">if</span> <span class="n">days_left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Expired&quot;</span><span class="p">,</span> <span class="n">days_left</span>
        <span class="k">elif</span> <span class="n">days_left</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Expiring Soon&quot;</span><span class="p">,</span> <span class="n">days_left</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Valid&quot;</span><span class="p">,</span> <span class="n">days_left</span></div>

<div class="viewcode-block" id="CheckSSL.display"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CheckSSL.display">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the SSL certificate information in a formatted table.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ssl</span><span class="p">()</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;SSL Certificate Information&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Field&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">format_dn</span><span class="p">(</span><span class="n">dn_tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">rdn</span> <span class="ow">in</span> <span class="n">dn_tuple</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rdn</span><span class="p">])</span> <span class="k">if</span> <span class="n">dn_tuple</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>

        <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">subject_str</span> <span class="o">=</span> <span class="n">format_dn</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Subject&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subject_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">issuer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issuer&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">issuer_str</span> <span class="o">=</span> <span class="n">format_dn</span><span class="p">(</span><span class="n">issuer</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Issuer&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">issuer_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">not_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notBefore&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
        <span class="n">not_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notAfter&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Not Before&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">not_before</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Not After&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">not_after</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">days_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_expiry</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Expired&quot;</span><span class="p">:</span>
            <span class="n">status_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[red]</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> (Expired </span><span class="si">{</span><span class="o">-</span><span class="n">days_left</span><span class="si">}</span><span class="s2"> days ago)[/red]&quot;</span>
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;Expiring Soon&quot;</span><span class="p">:</span>
            <span class="n">status_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[red]</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> (Expires in </span><span class="si">{</span><span class="n">days_left</span><span class="si">}</span><span class="s2"> days)[/red]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[green]</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> (Expires in </span><span class="si">{</span><span class="n">days_left</span><span class="si">}</span><span class="s2"> days)[/green]&quot;</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Expiry Status&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">san</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subjectAltName&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">san_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">san</span><span class="p">])</span> <span class="k">if</span> <span class="n">san</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="s2">&quot;Subject Alt Names&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">san_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CallWebsocket"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallWebsocket">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">CallWebsocket</span><span class="p">:</span>
<div class="viewcode-block" id="CallWebsocket.__init__"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallWebsocket.__init__">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">on_send</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">on_receive</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">enable_status_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">ssl_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ping_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">max_fail_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the CallWebsocket.</span>

<span class="sd">        :param url: WebSocket URL for connection.</span>
<span class="sd">        :param verbose: Level of verbosity for logging.</span>
<span class="sd">        :param timeout: Timeout duration for the WebSocket connection.</span>
<span class="sd">        :param on_send: Callable function for sending messages.</span>
<span class="sd">        :param on_receive: Callable function for receiving messages.</span>
<span class="sd">        :param enable_status_console: If True, status console will be enabled.</span>
<span class="sd">        :param ssl_options: SSL options for secure WebSocket connections.</span>
<span class="sd">        :param headers: Optional headers for WebSocket connection.</span>
<span class="sd">        :param ping_interval: Interval in seconds for sending ping messages.</span>
<span class="sd">        :param max_retries: Number of retries for a single reconnection attempt.</span>
<span class="sd">        :param max_fail_count: Maximum allowed total failure count before giving up.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_send</span> <span class="o">=</span> <span class="n">on_send</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_receive</span> <span class="o">=</span> <span class="n">on_receive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_status_console</span> <span class="o">=</span> <span class="n">enable_status_console</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span> <span class="o">=</span> <span class="n">ssl_options</span> <span class="ow">or</span> <span class="p">{</span><span class="s2">&quot;cert_reqs&quot;</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="o">=</span> <span class="n">ping_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_fail_count</span> <span class="o">=</span> <span class="n">max_fail_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">ConsoleLoggerAdapter</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s2">&quot;CallWebsocketLogger&quot;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span> <span class="o">=</span> <span class="n">append_ws</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span> <span class="o">=</span> <span class="n">Null</span><span class="p">()</span>  <span class="c1"># Placeholder for status console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icon_rpc_helper</span> <span class="o">=</span> <span class="n">IconRpcHelper</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">http_url</span><span class="si">}</span><span class="s2">/api/v3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="p">:</span> <span class="n">WebSocket</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Enable detailed trace if verbosity level is high</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">enableTrace</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="CallWebsocket.connect"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallWebsocket.connect">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish a WebSocket connection.</span>

<span class="sd">        :param api_path: Additional API path to append to the WebSocket URL.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="CallWebsocket.reconnect"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallWebsocket.reconnect">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to reconnect to the WebSocket server.</span>

<span class="sd">        :param api_path: API path for WebSocket reconnection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_fail_count</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exceeded max fail count of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_fail_count</span><span class="si">}</span><span class="s2">. Stopping reconnection attempts.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># self.logger.info(f&quot;Attempting to reconnect... ({attempt + 1}/{self.max_retries})&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
                <span class="c1"># Check if the connection was successful</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reconnection successful&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_communication</span><span class="p">()</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reconnection attempt (</span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">) failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait before retrying</span>

        <span class="c1"># Increment fail count after all retry attempts fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># If max retries are reached without success, log and close the connection.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Max reconnection attempts reached. Closing WebSocket.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sys_exit</span><span class="p">(</span><span class="s2">&quot;Max reconnection attempts reached. Closing WebSocket.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span><span class="p">)</span>
        <span class="n">_ws_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span><span class="si">}{</span><span class="n">api_path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">(</span>
            <span class="n">_ws_url</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">sslopt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

<div class="viewcode-block" id="CallWebsocket.run"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallWebsocket.run">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/api/v3/icon_dex/block&quot;</span><span class="p">,</span> <span class="n">use_status_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the WebSocket communication.</span>

<span class="sd">        :param api_path: API path for the WebSocket connection.</span>
<span class="sd">        :param use_status_console: Enable status console during the communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_status_console</span> <span class="ow">or</span> <span class="n">use_status_console</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;Call WebSocket&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_communication</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_communication</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles sending and receiving messages over the WebSocket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Send initial message if on_send is defined</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_send</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Start a loop for receiving messages and sending periodic pings</span>
            <span class="n">last_ping_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Handle pings</span>
                    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_ping_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                        <span class="n">last_ping_time</span> <span class="o">=</span> <span class="n">current_time</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ping sent&quot;</span><span class="p">)</span>

                    <span class="c1"># Receive messages</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">on_receive</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">ConnectionResetError</span><span class="p">,</span> <span class="n">WebSocketConnectionClosedException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WebSocket connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during message handling: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send initial message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="CallWebsocket.close"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.CallWebsocket.close">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Close the WebSocket connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WebSocket connection closed.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GoloopWebsocket"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">GoloopWebsocket</span><span class="p">(</span><span class="n">CallWebsocket</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">url</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">blockheight</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">sec_thresholds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">monitoring_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ignore_ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">network_info</span><span class="p">:</span> <span class="n">NetworkInfo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">on_send</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">on_receive</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">blockheight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec_thresholds</span> <span class="o">=</span> <span class="n">sec_thresholds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_target</span> <span class="o">=</span> <span class="n">monitoring_target</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_target</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compare_diff_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_cnt</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp_prev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="n">network_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Stores parsed transfer data for reuse</span>


        <span class="k">if</span> <span class="n">ignore_ssl</span><span class="p">:</span>
            <span class="n">disable_ssl_warnings</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">use_status_console</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_status_console</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">on_send</span><span class="o">=</span><span class="n">on_send</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_blockheight_callback</span><span class="p">,</span>
            <span class="n">on_receive</span><span class="o">=</span><span class="n">on_receive</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_blockheight</span><span class="p">,</span>
            <span class="n">enable_status_console</span><span class="o">=</span><span class="n">use_status_console</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="GoloopWebsocket.request_blockheight_callback"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.request_blockheight_callback">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">request_blockheight_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_blockheight</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve the block height. blockheight: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">,  response: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_response_content</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call request_blockheight_callback - blockheight: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_and_store_preps_info</span><span class="p">()</span>

        <span class="n">send_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">send_data</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_multiple_keys_exists</span><span class="p">(</span><span class="n">dict_items</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keys_exists</span><span class="p">(</span><span class="n">dict_items</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="GoloopWebsocket.parse_transfer_tx"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.parse_transfer_tx">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_transfer_tx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmed_transaction_list</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a list of confirmed transactions, store transfer details,</span>
<span class="sd">        and log them.</span>

<span class="sd">        :param confirmed_transaction_list: A list of confirmed transactions.</span>
<span class="sd">        :return: A list of parsed transfer details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Clear previous transfers</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmed_transaction_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="n">confirmed_transaction_list</span><span class="p">:</span>
                <span class="n">transfer_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_transaction_data</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">transfer_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transfer_data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_transfer</span><span class="p">(</span><span class="o">**</span><span class="n">transfer_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_transaction_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract and parse transfer details from a transaction.</span>

<span class="sd">        :param transaction: A transaction dictionary.</span>
<span class="sd">        :return: A dictionary containing parsed transfer details, or None if invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_from</span> <span class="o">=</span> <span class="n">shorten_text</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shorten_middle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_to</span> <span class="o">=</span> <span class="n">shorten_text</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shorten_middle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_value</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_from</span> <span class="ow">and</span> <span class="n">_to</span> <span class="ow">and</span> <span class="n">_value</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_value</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">TINT</span>
                <span class="k">if</span> <span class="n">_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;from_address&quot;</span><span class="p">:</span> <span class="n">_from</span><span class="p">,</span> <span class="s2">&quot;to_address&quot;</span><span class="p">:</span> <span class="n">_to</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">_value</span><span class="p">}</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value conversion in transaction: </span><span class="si">{</span><span class="n">_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log transfer details to the console.</span>

<span class="sd">        :param from_address: The sender&#39;s address.</span>
<span class="sd">        :param to_address: The recipient&#39;s address.</span>
<span class="sd">        :param value: The amount transferred in ICX.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TRANSFER] </span><span class="si">{</span><span class="n">from_address</span><span class="si">}</span><span class="s2"> 👉 </span><span class="si">{</span><span class="n">to_address</span><span class="si">}</span><span class="s2"> 💰 </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> ICX&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GoloopWebsocket.parse_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.parse_blockheight">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_diff_time</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">response_json</span> <span class="ow">and</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">):</span>
            <span class="n">hash_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_block_hash</span><span class="p">(</span><span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hash_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirmed_transaction_list&#39;</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">confirmed_transaction_list</span> <span class="o">=</span> <span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirmed_transaction_list&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">confirmed_transaction_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parse_transfer_tx</span><span class="p">(</span><span class="n">confirmed_transaction_list</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span> <span class="o">=</span> <span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">LAST_EXECUTE_POINT</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span> <span class="o">=</span> <span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_stamp&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp_prev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compare_diff_time</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp_prev</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span><span class="p">)</span>

            <span class="n">tx_list</span> <span class="o">=</span> <span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirmed_transaction_list&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tx_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tx_list</span><span class="p">)</span>

            <span class="n">peer_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peer_id&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">peer_id</span><span class="p">:</span>
                <span class="n">peer_name</span> <span class="o">=</span> <span class="n">shorten_text</span><span class="p">(</span><span class="n">peer_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peer_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">_message</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[[bold dodger_blue1]📦 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">[/bold dodger_blue1]] 📅 </span><span class="si">{</span><span class="n">date_utils</span><span class="o">.</span><span class="n">timestamp_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;tx_cnt: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_count</span><span class="si">}</span><span class="s2">, tx_hash: </span><span class="si">{</span><span class="n">shorten_text</span><span class="p">(</span><span class="n">hash_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_hash&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">shorten_middle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">, Validator: </span><span class="si">{</span><span class="n">peer_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_message</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">tx_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;0x0&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 16진수, timestamp가 string이여야한다.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compare_diff_time</span><span class="p">[</span><span class="s1">&#39;tx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_target</span><span class="p">:</span>
                    <span class="n">diff_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_diff_time</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1_000_000</span>
                    <span class="k">if</span> <span class="n">diff_time</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec_thresholds</span><span class="p">:</span>
                        <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">:</span><span class="s2">^5</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="p">(</span><span class="n">key_string</span><span class="o">=</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">diff_time</span><span class="o">=</span><span class="n">diff_time</span><span class="p">,</span><span class="w"> </span><span class="n">is_string</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">dump</span><span class="p">(</span><span class="n">hash_result</span><span class="p">[</span><span class="s1">&#39;confirmed_transaction_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoloopWebsocket.output_format"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.output_format">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">output_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_string</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">diff_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_cnt</span><span class="p">[</span><span class="n">key_string</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_cnt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key_string</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">blockheight_date</span> <span class="o">=</span> <span class="n">date_utils</span><span class="o">.</span><span class="n">timestamp_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_string</span> <span class="o">==</span> <span class="s2">&quot;block&quot;</span><span class="p">:</span>
            <span class="n">diff_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BH_time(now): </span><span class="si">{</span><span class="n">blockheight_date</span><span class="si">}</span><span class="s2">, &quot;</span> \
                           <span class="sa">f</span><span class="s2">&quot;BH_time(prev): </span><span class="si">{</span><span class="n">date_utils</span><span class="o">.</span><span class="n">timestamp_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp_prev</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;BH_time: </span><span class="si">{</span><span class="n">blockheight_date</span><span class="si">}</span><span class="s2">, TX_time: </span><span class="si">{</span><span class="n">date_utils</span><span class="o">.</span><span class="n">timestamp_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_cnt</span><span class="p">[</span><span class="n">key_string</span><span class="p">]</span><span class="si">}</span><span class="s2">&gt; [</span><span class="si">{</span><span class="n">key_string</span><span class="si">}</span><span class="s2"> Delay][</span><span class="si">{</span><span class="n">date_utils</span><span class="o">.</span><span class="n">second_to_dayhhmm</span><span class="p">(</span><span class="n">diff_time</span><span class="p">)</span><span class="si">}</span><span class="s2">] &quot;</span><span class="p">,</span>
                  <span class="sa">f</span><span class="s2">&quot;BH: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="si">}</span><span class="s2">, &quot;</span>
                  <span class="c1"># f&quot;diff: {date_utils.second_to_dayhhmm(diff_time)}, &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;TX_CNT:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tx_count</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">diff_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GoloopWebsocket.get_response_content"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.get_response_content">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_response_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_rpc_helper</span><span class="o">.</span><span class="n">response</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoloopWebsocket.get_last_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.get_last_blockheight">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_last_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;icx_getLastBlock&#39;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.height&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoloopWebsocket.get_preps"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.get_preps">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_preps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getPReps&#39;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.preps&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoloopWebsocket.get_validator_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.get_validator_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_validator_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getValidatorsInfo&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.validators&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="GoloopWebsocket.fetch_and_store_preps_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.fetch_and_store_preps_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_and_store_preps_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">,</span> <span class="s2">&quot;platform&quot;</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">)</span>

            <span class="n">platform_methods</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_preps</span><span class="p">,</span> <span class="s2">&quot;nodeAddress&quot;</span><span class="p">),</span>
                <span class="s2">&quot;havah&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_validator_info</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">platform_methods</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">platform_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">platform_methods</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported platform&quot;</span><span class="p">)</span>

            <span class="n">fetch_method</span><span class="p">,</span> <span class="n">key_name</span> <span class="o">=</span> <span class="n">platform_methods</span><span class="p">[</span><span class="n">platform_name</span><span class="p">]</span>

            <span class="n">preps_list</span> <span class="o">=</span> <span class="n">fetch_method</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">prep</span> <span class="ow">in</span> <span class="n">preps_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key_name</span> <span class="ow">in</span> <span class="n">prep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span><span class="p">[</span><span class="n">prep</span><span class="p">[</span><span class="n">key_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prep</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="GoloopWebsocket.execute_rpc_call"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.execute_rpc_call">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute_rpc_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span><span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">governance_address</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_rpc_helper</span><span class="o">.</span><span class="n">governance_call</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="n">governance_address</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_rpc_helper</span><span class="o">.</span><span class="n">rpc_call</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]\[warn][/yellow] Response  is None. method=&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;return_key=&#39;</span><span class="si">{</span><span class="n">return_key</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_response_content</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="GoloopWebsocket.get_block_hash"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.get_block_hash">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_block_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">jequest</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">http_url</span><span class="si">}</span><span class="s2">/api/v3&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">generate_json_rpc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getBlockByHash&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">tx_hash</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_tx_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">jequest</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">http_url</span><span class="si">}</span><span class="s2">/api/v3&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">generate_json_rpc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getTransactionResult&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="n">tx_hash</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">json_response</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">json_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GoloopWebsocket.get_tx_result"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.GoloopWebsocket.get_tx_result">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_tx_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon_rpc_helper</span><span class="o">.</span><span class="n">get_tx_wait</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="n">max_attempts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;failure&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;failure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resp</span></div></div>


<div class="viewcode-block" id="AsyncCallWebsocket"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncCallWebsocket</span><span class="p">(</span><span class="n">LoggerMixinVerbose</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">on_send</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">on_receive</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ssl_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ping_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">max_fail_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">enable_status_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">additional_tasks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Awaitable</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_send</span> <span class="o">=</span> <span class="n">on_send</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_receive</span> <span class="o">=</span> <span class="n">on_receive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span> <span class="o">=</span> <span class="n">ping_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_fail_count</span> <span class="o">=</span> <span class="n">max_fail_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">additional_tasks</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">api_path</span> <span class="o">=</span> <span class="s2">&quot;/api/v3/icon_dex/block&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span> <span class="o">=</span> <span class="n">append_ws</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable_status_console</span> <span class="o">=</span> <span class="n">enable_status_console</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For rich console status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;blockheight&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;skip_start_block&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># The block height where skipping started</span>
            <span class="s2">&quot;current_skipped_block&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># The block height currently being skipped</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">on_last_status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># self.logger = ConsoleLoggerAdapter(logger, &quot;AsyncCallWebsocket&quot;, verbose &gt; 0)</span>
        <span class="c1"># self.logger = setup_logger(logger, &quot;pawnlib.http.AsyncCallWebsocket&quot;, verbose)</span>
        <span class="c1"># self.logger = logger or self.get_logger()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ssl_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span> <span class="o">=</span> <span class="n">ssl_options</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>

<div class="viewcode-block" id="AsyncCallWebsocket.connect"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket.connect">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_path</span><span class="p">:</span>
            <span class="n">api_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_path</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncCallWebsocket.reconnect"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket.reconnect">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_path</span><span class="p">:</span>
            <span class="n">api_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_fail_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exceeded max fail count of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_fail_count</span><span class="si">}</span><span class="s2">. Stopping reconnection attempts.&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reconnection successful. status=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reconnection attempt (</span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">) failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Max reconnection attempts reached. Closing WebSocket.&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sys_exit</span><span class="p">(</span><span class="s2">&quot;Max reconnection attempts reached. Closing WebSocket.&quot;</span><span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_path</span><span class="p">:</span>
            <span class="n">api_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span> <span class="o">=</span> <span class="n">append_ws</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}{</span><span class="n">api_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">ws_connect</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span><span class="p">,</span>
                <span class="n">ssl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_options</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WebSocket connection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="AsyncCallWebsocket.run_tasks"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket.run_tasks">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle_communication</span><span class="p">()]</span>
        <span class="n">task_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">task</span><span class="p">())</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">])</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">task_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncCallWebsocket.run"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket.run">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/api/v3/icon_dex/block&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_status_console</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;[bold green]Connecting to WebSocket...&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span> <span class="o">=</span> <span class="n">status</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span></div>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_ping_time</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">ping_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ping_loop</span><span class="p">(</span><span class="n">last_ping_time</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Send message if available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_send</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_send</span><span class="p">()</span> <span class="k">if</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_send</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_send</span><span class="p">()</span>
                <span class="n">function_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_send</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending message from </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">, type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending message to WebSocket at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ws_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">send_str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message sent: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;WebSocket is closed or not connected, cannot send message.&quot;</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid message: either None or not a string.&quot;</span><span class="p">)</span>

            <span class="c1"># Main loop for handling received messages</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">WSMsgType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_receive</span><span class="p">:</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_receive</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">WSMsgType</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WebSocket connection closed by server.&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
                    <span class="k">break</span>

                <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">WSMsgType</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WebSocket error: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
                    <span class="k">break</span>

                <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">WSMsgType</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WebSocket is closing...&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown message type: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
                    <span class="k">break</span>

        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WebSocket connection error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ContentTypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content type error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Task was cancelled.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">notify_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">additional_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_last_status</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ping_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">ping_task</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ping task cancelled.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ping_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_ping_time</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_ping_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ping_interval</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
                    <span class="n">last_ping_time</span> <span class="o">=</span> <span class="n">current_time</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ping sent&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;WebSocket is closed, skipping ping.&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="AsyncCallWebsocket.close"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket.close">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_on_close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_connected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;WebSocket connection closed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;WebSocket was already closed.&quot;</span><span class="p">)</span>

        <span class="c1"># Stop any ongoing tasks or operations if WebSocket is closed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_status_console</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">exit_on_close</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.asyncio.async_helper</span><span class="w"> </span><span class="kn">import</span> <span class="n">shutdown_async_tasks</span>
            <span class="k">await</span> <span class="n">shutdown_async_tasks</span><span class="p">(</span><span class="n">exit_on_shutdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="n">exit_code</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncCallWebsocket.graceful_close"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncCallWebsocket.graceful_close">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">graceful_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gracefully close the event loop and clean up resources before exit.</span>
<span class="sd">        Args:</span>
<span class="sd">             exit_code (int): Exit code to return when exiting the system (default is 0).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="n">pending</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pending</span><span class="p">)</span><span class="si">}</span><span class="s2"> pending tasks.&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">pending</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">task</span>
                        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2"> cancelled successfully.&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during task cancellation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Event loop closed gracefully.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during graceful close: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System shutting down gracefully with exit code </span><span class="si">{</span><span class="n">exit_code</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AsyncGoloopWebsocket"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncGoloopWebsocket</span><span class="p">(</span><span class="n">AsyncCallWebsocket</span><span class="p">):</span>
    <span class="n">BLOCKHEIGHT_FILE</span> <span class="o">=</span> <span class="s2">&quot;last_blockheight.txt&quot;</span>
    <span class="n">SLACK_BLOCKHEIGHT_FILE</span> <span class="o">=</span> <span class="s2">&quot;last_slack_blockheight.txt&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">blockheight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">sec_thresholds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">monitoring_target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ignore_ssl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">network_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NetworkInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">on_send</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">on_receive</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span> <span class="n">Console</span><span class="p">,</span> <span class="n">ConsoleLoggerAdapter</span><span class="p">,</span> <span class="n">Null</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">process_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">address_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">send_slack</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">slack_webhook_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">max_transaction_attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">check_tx_result_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">ignore_data_types</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">session</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">preps_refresh_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
            <span class="n">use_shorten_tx_hash</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">bps_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">skip_until</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">base_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">blockheight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sec_thresholds</span> <span class="o">=</span> <span class="n">sec_thresholds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_target</span> <span class="o">=</span> <span class="n">monitoring_target</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;block&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare_diff_time</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_cnt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp_prev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_timestamp_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span> <span class="o">=</span> <span class="n">network_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_last</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Stores parsed transfer data for reuse</span>
        <span class="c1"># self.blockheight = blockheight</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_data_types</span> <span class="o">=</span> <span class="n">ignore_data_types</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_slack</span> <span class="o">=</span> <span class="n">send_slack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slack_webhook_url</span> <span class="o">=</span> <span class="n">slack_webhook_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span> <span class="o">=</span> <span class="n">max_transaction_attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_tx_result_enabled</span> <span class="o">=</span> <span class="n">check_tx_result_enabled</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start AsyncGoloopWebsocket&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preps_refresh_interval</span> <span class="o">=</span> <span class="n">preps_refresh_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_shorten_tx_hash</span> <span class="o">=</span> <span class="n">use_shorten_tx_hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bps_interval</span> <span class="o">=</span> <span class="n">bps_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_until</span> <span class="o">=</span> <span class="n">skip_until</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tps_tx_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bps_block_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_block_height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_logged_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">address_filter</span> <span class="o">=</span> <span class="n">address_filter</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_filter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_addresses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_address_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_filter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The address_filter is not defined, so all transactions will be logged.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process_transaction_callback</span> <span class="o">=</span> <span class="n">process_transaction</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_process_transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">AsyncIconRpcHelper</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ignore_ssl</span><span class="p">:</span>
            <span class="n">disable_ssl_warnings</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">use_status_console</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_status_console</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">on_send</span><span class="o">=</span><span class="n">on_send</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_blockheight_callback</span><span class="p">,</span>
            <span class="n">on_receive</span><span class="o">=</span><span class="n">on_receive</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_confirmed_transaction_list</span><span class="p">,</span>
            <span class="n">enable_status_console</span><span class="o">=</span><span class="n">use_status_console</span><span class="p">,</span>
            <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="n">additional_tasks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periodic_preps_update</span><span class="p">],</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AsyncGoloopWebsocket.read_last_processed_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.read_last_processed_blockheight">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">read_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">skip_log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the last processed block height from a file.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="si">}{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">blockheight</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_log</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🫡 Read last processed blockheight : </span><span class="si">{</span><span class="n">blockheight</span><span class="si">}</span><span class="s2"> on &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">blockheight</span>  <span class="c1"># Assuming block height is stored in hex</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading block height file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> on &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_log</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block recorded file not found - &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.write_last_processed_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.write_last_processed_blockheight">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">write_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">blockheight</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the last successfully processed block height to a file.&quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="si">}{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block height file &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39; not found. Creating new file.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully processed block </span><span class="si">{</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">. Block height recorded on &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error writing block height to file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> on &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error occurred while writing block height: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> on &#39;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AsyncGoloopWebsocket.run_from_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.run_from_blockheight">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_from_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blockheight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">api_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/api/v3/icon_dex/block&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run starting from a specified block height, the latest block, or the last recorded block height.</span>

<span class="sd">        :param blockheight: The block height to start from.</span>
<span class="sd">                            - If None, tries to resume from the last saved block.</span>
<span class="sd">                            - If 0, starts from the latest block.</span>
<span class="sd">                            - Otherwise, starts from the provided block height.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">blockheight</span> <span class="ow">and</span> <span class="n">is_hex</span><span class="p">(</span><span class="n">blockheight</span><span class="p">):</span>
            <span class="n">blockheight</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">blockheight</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">latest_blockheight</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retry_operation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_last_blockheight</span><span class="p">,</span>
                <span class="n">max_attempts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="p">,</span>
                <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch block_height after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch block_height after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">blockheight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">blockheight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">blockheight</span> <span class="o">&gt;</span> <span class="n">latest_blockheight</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested block height </span><span class="si">{</span><span class="n">blockheight</span><span class="si">}</span><span class="s2"> is higher than the latest block </span><span class="si">{</span><span class="n">latest_blockheight</span><span class="si">}</span><span class="s2">. Starting from the latest block.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">latest_blockheight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">blockheight</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting from specified block height: </span><span class="si">{</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">blockheight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">latest_blockheight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting from the most recent block height: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLACK_BLOCKHEIGHT_FILE</span><span class="p">,</span> <span class="n">latest_blockheight</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BLOCKHEIGHT_FILE</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">&gt;</span> <span class="n">latest_blockheight</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Resumed block height </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2"> exceeds the latest block height </span><span class="si">{</span><span class="n">latest_blockheight</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Starting from the latest block height instead.&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">latest_blockheight</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming from last processed block height: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latest_blockheight</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">difference</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">latest_blockheight</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">)</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">100</span>
                    <span class="k">if</span> <span class="n">difference</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️⚠️ Latest blockheight = </span><span class="si">{</span><span class="n">latest_blockheight</span><span class="si">}</span><span class="s2"> ⛓️, &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;Current blockheight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2"> ⛓️, &quot;</span>
                                            <span class="sa">f</span><span class="s2">&quot;Difference = </span><span class="si">{</span><span class="n">difference</span><span class="si">}</span><span class="s2"> 🚨 exceeds threshold </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> 📉&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Latest blockheight = </span><span class="si">{</span><span class="n">latest_blockheight</span><span class="si">}</span><span class="s2"> ⛓️, &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;Current blockheight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2"> ⛓️, &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;Difference = </span><span class="si">{</span><span class="n">difference</span><span class="si">}</span><span class="s2"> 😊&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="n">latest_blockheight</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No previous block height found. Starting from the latest block: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Connect to WebSocket and start running tasks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_status_console</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;[bold green]Connecting to WebSocket...&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_console</span> <span class="o">=</span> <span class="n">status</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">api_path</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_tasks</span><span class="p">()</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.initialize"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.initialize">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.periodic_preps_update"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.periodic_preps_update">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">periodic_preps_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_and_store_preps_info</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-Reps information updated. blockheight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_height&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update P-Reps information: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. blockheight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_height&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preps_refresh_interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.request_blockheight_callback"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.request_blockheight_callback">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">request_blockheight_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_last_blockheight</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">:</span>
            <span class="c1"># raise ValueError(f&quot;Failed to retrieve the block height. blockheight: {self.blockheight}, response: {await self.get_response_content()}&quot;)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to retrieve the block height. blockheight: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">, response: &quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🚀 Requesting block height: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">send_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">send_data</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.fetch_and_store_preps_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.fetch_and_store_preps_info">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_and_store_preps_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">platform_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">,</span> <span class="s2">&quot;platform&quot;</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">)</span>
            <span class="n">platform_methods</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_preps</span><span class="p">,</span> <span class="s2">&quot;nodeAddress&quot;</span><span class="p">),</span>
                <span class="s2">&quot;havah&quot;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_validator_info</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">platform_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">platform_methods</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported platform&quot;</span><span class="p">)</span>

            <span class="n">fetch_method</span><span class="p">,</span> <span class="n">key_name</span> <span class="o">=</span> <span class="n">platform_methods</span><span class="p">[</span><span class="n">platform_name</span><span class="p">]</span>
            <span class="n">preps_list</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_method</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">prep</span> <span class="ow">in</span> <span class="n">preps_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prep</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key_name</span> <span class="ow">in</span> <span class="n">prep</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span><span class="p">[</span><span class="n">prep</span><span class="p">[</span><span class="n">key_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">prep</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching P-Reps with </span><span class="si">{</span><span class="n">fetch_method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(): </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.parse_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.parse_blockheight">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse block height with retry logic.</span>

<span class="sd">        :param response: The response containing block height data.</span>
<span class="sd">        :param delay: Delay (in seconds) between retry attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retry_operation</span><span class="p">(</span>
                <span class="n">get_blockheight</span><span class="p">,</span>
                <span class="n">max_attempts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="p">,</span>
                <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">response</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block height parsed: </span><span class="si">{</span><span class="n">hex_to_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse block height after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="si">}</span><span class="s2"> attempts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.calculate_tps_bps"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.calculate_tps_bps">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tps_bps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_height</span><span class="p">,</span> <span class="n">tx_count</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; 10초 단위로 TPS 및 BPS 계산 &quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_start_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_start_time</span> <span class="o">=</span> <span class="n">current_time</span>  <span class="c1"># 10초 측정 시작 시간</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tps_tx_count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 10초 동안 처리된 TX 개수</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bps_block_count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 10초 동안 수신된 블록 개수</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_block_height</span> <span class="o">=</span> <span class="n">block_height</span>  <span class="c1"># 10초 동안의 시작 블록</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_logged_time</span> <span class="o">=</span> <span class="n">current_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tps_tx_count</span> <span class="o">+=</span> <span class="n">tx_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bps_block_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_start_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bps_interval</span><span class="p">:</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_start_time</span>
            <span class="n">end_block_height</span> <span class="o">=</span> <span class="n">block_height</span>  <span class="c1"># 마지막 블록 높이</span>

            <span class="n">tps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tps_tx_count</span> <span class="o">/</span> <span class="n">elapsed_time</span> <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">bps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bps_block_count</span> <span class="o">/</span> <span class="n">elapsed_time</span> <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="c1"># self.logger.info(</span>
            <span class="c1">#     f&quot;📊 [{self.bps_interval}s Stats] TPS: {tps:.2f} TX/s | BPS: {bps:.2f} Blocks/s | &quot;</span>
            <span class="c1">#     f&quot;TXs: {self.tps_tx_count} | Blocks: {self.bps_block_count} | &quot;</span>
            <span class="c1">#     f&quot;Block Range: {self.start_block_height} → {end_block_height} | &quot;</span>
            <span class="c1">#     f&quot;Elapsed: {elapsed_time:.2f}s&quot;</span>
            <span class="c1"># )</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📊 [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bps_interval</span><span class="si">}</span><span class="s2">s Stats] BPS: </span><span class="si">{</span><span class="n">bps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Blocks/s | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Blocks: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bps_block_count</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Block Range: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start_block_height</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">end_block_height</span><span class="si">}</span><span class="s2"> | &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Elapsed: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span>
            <span class="p">)</span>

            <span class="c1"># # Slack 알림 전송</span>
            <span class="c1"># if self.bps_block_count &gt; 0 or self.tps_tx_count &gt; 0:</span>
            <span class="c1">#     slack_message = (</span>
            <span class="c1">#         f&quot;🚀 [10s Network Update]\n&quot;</span>
            <span class="c1">#         f&quot;🔹 TPS: {tps:.2f} TX/s\n&quot;</span>
            <span class="c1">#         f&quot;🔹 BPS: {bps:.2f} Blocks/s\n&quot;</span>
            <span class="c1">#         f&quot;📈 TXs: {self.tps_tx_count} | Blocks: {self.bps_block_count}\n&quot;</span>
            <span class="c1">#         f&quot;🔄 Block Range: {self.start_block_height} → {end_block_height} | Elapsed: {elapsed_time:.2f}s&quot;</span>
            <span class="c1">#     )</span>
            <span class="c1">#     await self.send_slack_notification(slack_message)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_start_time</span> <span class="o">=</span> <span class="n">current_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tps_tx_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bps_block_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_block_height</span> <span class="o">=</span> <span class="n">block_height</span>  <span class="c1"># 새로운 10초 구간의 시작 블록</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.handle_confirmed_transaction_list"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.handle_confirmed_transaction_list">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_confirmed_transaction_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON response: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">)</span>
        <span class="n">block_height</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span> <span class="o">=</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
        <span class="n">readable_block_height</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bps_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tps_bps</span><span class="p">(</span><span class="n">block_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_until</span><span class="p">:</span>
           <span class="n">last_slack_blockheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_until</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_slack_blockheight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLACK_BLOCKHEIGHT_FILE</span><span class="p">,</span> <span class="n">skip_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">block_height</span> <span class="ow">and</span> <span class="n">last_slack_blockheight</span> <span class="ow">and</span> <span class="n">block_height</span> <span class="o">&lt;</span>  <span class="n">last_slack_blockheight</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_start_block&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏩ [Skipping Started] Block </span><span class="si">{</span><span class="n">block_height</span><span class="si">}</span><span class="s2">  👉 </span><span class="si">{</span><span class="n">last_slack_blockheight</span><span class="si">}</span><span class="s2"> - Preventing duplicate processing.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="p">[</span><span class="s1">&#39;skip_start_block&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_height</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BLOCKHEIGHT_FILE</span><span class="p">,</span> <span class="n">block_height</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⏩ Block </span><span class="si">{</span><span class="n">block_height</span><span class="si">}</span><span class="s2"> skipped to prevent duplicate processing, until last_slack_blockheight=</span><span class="si">{</span><span class="n">last_slack_blockheight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>  <span class="c1"># Slack 전송 스킵</span>

        <span class="k">if</span> <span class="n">tx_hash</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_start_block&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="p">[</span><span class="s1">&#39;skip_start_block&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="p">[</span><span class="s1">&#39;current_start_block&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_height</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ [Skipping Stopped] Resuming at Block </span><span class="si">{</span><span class="n">block_height</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">is_success</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="n">check_key_and_type</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;confirmed_transaction_list&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

            <span class="n">block_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">block_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">retry_operation</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_block_hash</span><span class="p">,</span>
                    <span class="n">max_attempts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="p">,</span>
                    <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">tx_hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">,</span>
                    <span class="n">success_criteria</span><span class="o">=</span><span class="n">is_success</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Network-related error while fetching block data on </span><span class="si">{</span><span class="n">readable_block_height</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse transaction after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_transaction_attempts</span><span class="si">}</span><span class="s2"> attempts for tx hash </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">block_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">block_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid block data received for tx hash </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">pawnlib.utils.notify</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_slack</span>
                <span class="n">send_slack</span><span class="p">(</span>
                    <span class="n">msg_text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid block data received for tx hash </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2"> in blockheight </span><span class="si">{</span><span class="n">readable_block_height</span><span class="si">}</span><span class="s2"> block_data=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">block_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="c1"># msg_text=dict(Text=f&quot;Invalid block data received for tx hash {tx_hash} in blockheight {readable_block_height}&quot;,</span>
                    <span class="c1">#               block_data={str(block_data)}),</span>
                    <span class="n">status</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                    <span class="n">msg_level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="n">icon_emoji</span><span class="o">=</span><span class="s2">&quot;:alert:&quot;</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">graceful_close</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># await shutdown_async_tasks(1)</span>
                <span class="k">return</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">validator_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prep_info</span><span class="p">(</span><span class="n">block_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;peer_id&#39;</span><span class="p">),</span> <span class="n">apply_format</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">date_utils</span><span class="o">.</span><span class="n">timestamp_to_string</span><span class="p">(</span><span class="n">block_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_stamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">validator_info</span><span class="p">,</span> <span class="n">time_stamp</span> <span class="o">=</span>  <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">block_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">confirmed_transactions</span> <span class="o">=</span> <span class="n">block_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confirmed_transaction_list&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">confirmed_transactions_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">confirmed_transactions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BLOCKHEIGHT_FILE</span><span class="p">,</span> <span class="n">block_height</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_info</span><span class="p">[</span><span class="s1">&#39;block_height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_height</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="p">:</span>
                <span class="c1"># self.logger.info(f&quot;Block height parsed: {hex_to_number(self.blockheight_now, debug=True)}, TX: {confirmed_transactions_length}, Validator={validator_info}, &quot;</span>
                <span class="c1">#                  f&quot; 📅 {time_stamp}&quot;)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;🔗 Block: </span><span class="si">{</span><span class="n">hex_to_number</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blockheight_now</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;TXs: </span><span class="si">{</span><span class="n">confirmed_transactions_length</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;📅 </span><span class="si">{</span><span class="n">time_stamp</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Validator: </span><span class="si">{</span><span class="n">validator_info</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="p">)</span>
                <span class="c1"># self.logger.info(f&quot;Block height parsed: {hex_to_number(self.blockheight_now, debug=True)}, TX: {confirmed_transactions_length}&quot;)</span>
            <span class="k">if</span> <span class="n">confirmed_transactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block_data=</span><span class="si">{</span><span class="n">block_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">process_transaction_callback</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">block_height</span><span class="p">)</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">confirmed_transactions</span><span class="p">]</span>
                <span class="c1"># await asyncio.gather(*tasks, return_exceptions=True)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmed_transactions</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">confirmed_transactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;confirmed_transaction_list not found - </span><span class="si">{</span><span class="n">block_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.validate_address_filter"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.validate_address_filter">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_address_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address_filter</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
        <span class="n">valid_addresses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">invalid_addresses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address_filter</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">address_filter</span><span class="p">:</span>
            <span class="n">address_filter_list</span> <span class="o">=</span> <span class="n">address_filter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">address_filter_list</span> <span class="o">=</span> <span class="n">address_filter</span>

        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">address_filter_list</span><span class="p">:</span>
            <span class="n">_address</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_valid_token_address</span><span class="p">(</span><span class="n">_address</span><span class="p">):</span>
                <span class="n">valid_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_address</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invalid_addresses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_address</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">invalid_addresses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_invalid_addresses</span><span class="p">(</span><span class="n">invalid_addresses</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation failed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid_addresses</span><span class="p">)</span><span class="si">}</span><span class="s2"> invalid address(es) found in ADDRESS_FILTER.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">valid_addresses</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.log_invalid_addresses"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.log_invalid_addresses">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_invalid_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invalid_addresses</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">invalid_address</span> <span class="ow">in</span> <span class="n">invalid_addresses</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[red] Invalid hx address - &#39;</span><span class="si">{</span><span class="n">invalid_address</span><span class="si">}</span><span class="s2">&#39; (Please check the format or the address validity)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.highlight_address"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.highlight_address">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">highlight_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Highlights the address if it&#39;s part of the address_filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_filter</span><span class="p">:</span>
            <span class="c1"># Apply color for console log and bold for Slack messages</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[bold red]</span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">[/bold red]&quot;</span>  <span class="c1"># For logs</span>
        <span class="k">return</span> <span class="n">address</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.get_prep_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.get_prep_info">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_prep_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">apply_format</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the requested information from preps_info for a given address.</span>

<span class="sd">        :param address: The address to lookup in preps_info.</span>
<span class="sd">        :param key: The key for the desired value (default is &#39;name&#39;).</span>
<span class="sd">        :param apply_format: If True, applies format_text to the returned value for Slack formatting (default is False).</span>
<span class="sd">        :return: A formatted string with the value in parentheses, or an empty string if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">!=</span> <span class="s2">&quot;Unknown&quot;</span> <span class="ow">and</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span><span class="p">:</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">FlatDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preps_info</span><span class="p">[</span><span class="n">address</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_value</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">apply_format</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">format_text</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">return_value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.default_process_transaction"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.default_process_transaction">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">default_process_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">block_height</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the individual transactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tx_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_last_status</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Blockheight: </span><span class="si">{</span><span class="n">block_height</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">block_height_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🧱</span><span class="si">{</span><span class="n">block_height</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tx_data</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataType&#39;</span><span class="p">,</span> <span class="s2">&quot;send&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tx</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">from_address</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>
            <span class="n">to_address</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_data_types</span><span class="p">:</span>
                <span class="c1"># await self.log_message(f&quot;IGNORED dataType: {data_type}&quot;, level=&quot;debug&quot;)</span>
                <span class="k">return</span>

            <span class="c1"># Check for filtering</span>
            <span class="n">from_highlighted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlight_address</span><span class="p">(</span><span class="n">from_address</span><span class="p">)</span>
            <span class="n">to_highlighted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlight_address</span><span class="p">(</span><span class="n">to_address</span><span class="p">)</span>

            <span class="n">from_prep_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prep_info</span><span class="p">(</span><span class="n">from_address</span><span class="p">)</span>
            <span class="n">to_prep_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prep_info</span><span class="p">(</span><span class="n">to_address</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">from_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_filter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">to_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_filter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction passed: </span><span class="si">{</span><span class="n">from_address</span><span class="si">}{</span><span class="n">from_prep_label</span><span class="si">}</span><span class="s2"> 👉</span><span class="si">{</span><span class="n">to_address</span><span class="si">}{</span><span class="n">to_prep_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">method</span> <span class="o">=</span> <span class="n">tx_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;Send&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tx_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tx_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Send&quot;</span>
            <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;txHash&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_shorten_tx_hash</span><span class="p">:</span>
                <span class="n">shorten_tx_hash</span> <span class="o">=</span> <span class="n">get_shortened_tx_hash</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shorten_tx_hash</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="p">,</span> <span class="n">NetworkInfo</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">tracker</span><span class="p">:</span>
                <span class="n">_tracker_api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">tracker</span><span class="si">}</span><span class="s2">/transaction&quot;</span>
                <span class="n">full_tx_hash</span> <span class="o">=</span> <span class="n">format_link</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_tracker_api_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;[Check the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">network_info</span><span class="o">.</span><span class="n">network_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> Tracker] &quot;</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_tx_hash</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span><span class="si">}</span><span class="s2">_&quot;</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;setStake&quot;</span><span class="p">:</span>
                <span class="n">stake_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stake_value</span><span class="p">(</span><span class="n">tx_data</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🔵 &lt;Staking&gt; </span><span class="si">{</span><span class="n">block_height_text</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">from_highlighted</span><span class="si">}{</span><span class="n">from_prep_label</span><span class="si">}</span><span class="s2"> has staked 💰 </span><span class="si">{</span><span class="n">stake_value</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">slack_additional_message</span><span class="o">=</span><span class="n">full_tx_hash</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                    <span class="n">block_height</span><span class="o">=</span><span class="n">block_height</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;unStake&quot;</span><span class="p">:</span>
                <span class="n">stake_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stake_value</span><span class="p">(</span><span class="n">tx_data</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🔵 &lt;Staking&gt; </span><span class="si">{</span><span class="n">block_height_text</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">from_highlighted</span><span class="si">}{</span><span class="n">from_prep_label</span><span class="si">}</span><span class="s2"> has unstaked 💰 </span><span class="si">{</span><span class="n">stake_value</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="n">slack_additional_message</span><span class="o">=</span><span class="n">full_tx_hash</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                    <span class="n">block_height</span><span class="o">=</span><span class="n">block_height</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Send&quot;</span><span class="p">:</span>
                <span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formated_icx_value</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;send&quot;</span><span class="p">:</span>
                    <span class="n">_data_type_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_data_type_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">block_height_text</span><span class="si">}</span><span class="s2"> 💸 </span><span class="si">{</span><span class="n">shorten_tx_hash</span><span class="si">}</span><span class="s2">&lt;Send</span><span class="si">{</span><span class="n">_data_type_text</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">from_highlighted</span><span class="si">}{</span><span class="n">from_prep_label</span><span class="si">}</span><span class="s2"> 👉 </span><span class="si">{</span><span class="n">to_highlighted</span><span class="si">}{</span><span class="n">to_prep_label</span><span class="si">}</span><span class="s2"> 💰 </span><span class="si">{</span><span class="n">_value</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span>
                    <span class="n">slack_additional_message</span><span class="o">=</span><span class="n">full_tx_hash</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
                    <span class="n">block_height</span><span class="o">=</span><span class="n">block_height</span>
                <span class="p">)</span>
                <span class="c1"># await self.log_message(</span>
                <span class="c1">#     f&quot;💸TX ID: &lt;{shorten_tx_hash}&gt; &lt;Send{_data_type_text}&gt; \n&quot;</span>
                <span class="c1">#     f&quot;🗄 From:  {from_highlighted}{from_prep_label} \n&quot;</span>
                <span class="c1">#     f&quot;👉 To:  {to_highlighted}{to_prep_label} \n&quot;</span>
                <span class="c1">#     f&quot;💰 Amount:  {_value} &quot;,</span>
                <span class="c1">#     slack_additional_message=full_tx_hash,</span>
                <span class="c1">#     level=&quot;info&quot;</span>
                <span class="c1"># )</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🔶 &lt;</span><span class="si">{</span><span class="n">block_height_text</span><span class="si">}</span><span class="s2">&gt; &lt;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">{</span><span class="n">from_highlighted</span><span class="si">}</span><span class="s2"> performed action with data: </span><span class="si">{</span><span class="n">tx_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">block_height</span><span class="o">=</span><span class="n">block_height</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_tx_result_enabled</span><span class="p">:</span>
                <span class="c1"># tx_result = await self.ws_instance.get_tx_result(tx_hash)</span>
                <span class="n">tx_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span><span class="o">.</span><span class="n">get_tx_result</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tx_result</span> <span class="o">==</span> <span class="s2">&quot;OK&quot;</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ </span><span class="si">{</span><span class="n">shorten_tx_hash</span><span class="si">}</span><span class="s2"> TX Result received: </span><span class="si">{</span><span class="n">tx_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                           <span class="n">slack_additional_message</span><span class="o">=</span><span class="n">full_tx_hash</span><span class="p">,</span>
                                           <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">block_height</span><span class="o">=</span><span class="n">block_height</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ </span><span class="si">{</span><span class="n">shorten_tx_hash</span><span class="si">}</span><span class="s2"> Failed to retrieve TX Result: </span><span class="si">{</span><span class="n">tx_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                           <span class="n">slack_additional_message</span><span class="o">=</span><span class="n">full_tx_hash</span><span class="p">,</span>
                                           <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">block_height</span><span class="o">=</span><span class="n">block_height</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing transaction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tx_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tx_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">tx_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear data to avoid memory leaks</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.formated_icx_value"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.formated_icx_value">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">formated_icx_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">int_value</span> <span class="o">=</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">int_value</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> ICX` (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;`N/A ICX` (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.get_stake_value"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.get_stake_value">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stake_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_data</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># return hex_to_number(tx_data[&#39;params&#39;][&#39;value&#39;], is_comma=True, is_tint=is_tint)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">formated_icx_value</span><span class="p">(</span><span class="n">tx_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.get_send_value"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.get_send_value">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_send_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_data</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">tx_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">is_comma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="n">is_tint</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.log_message"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.log_message">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">slack_additional_message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="n">stack_level</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">block_height</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs a message using the specified level and optionally sends to Slack.</span>

<span class="sd">        :param message: The message to log.</span>
<span class="sd">        :param slack_additional_message: Additional message to send along with Slack (optional).</span>
<span class="sd">        :param level: The logging level (e.g., &#39;info&#39;, &#39;error&#39;, &#39;debug&#39;).</span>
<span class="sd">        :param stack_level: stack level</span>
<span class="sd">        :param block_height: block height</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Log to console using the specified log level</span>
            <span class="n">console_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">for_console</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
                <span class="n">log_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                <span class="n">log_method</span><span class="p">(</span><span class="n">console_message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="n">stack_level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">console_message</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="n">stack_level</span><span class="p">)</span>

            <span class="c1"># Optionally send to Slack asynchronously</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_slack</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">!=</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">block_height</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_last_processed_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SLACK_BLOCKHEIGHT_FILE</span><span class="p">,</span> <span class="n">block_height</span><span class="p">)</span>

                <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_slack_notification</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">slack_additional_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.format_message"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.format_message">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">format_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">for_console</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Formats a message for either console or Slack.</span>

<span class="sd">        :param message: The original message.</span>
<span class="sd">        :param for_console: True if formatting for console, False for Slack.</span>
<span class="sd">        :return: Formatted message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">for_console</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[bold red]&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[/bold red]&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>  <span class="c1"># Slack uses * for bold</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.get_slack_color_by_level"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.get_slack_color_by_level">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_slack_color_by_level</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a color code for Slack messages based on log level.</span>

<span class="sd">        :param level: The log level (e.g., &#39;warn&#39;, &#39;error&#39;, &#39;info&#39;, &#39;critical&#39;).</span>
<span class="sd">        :return: Hex color code as a string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="s2">&quot;#ffcc00&quot;</span>  <span class="c1"># Yellow for warnings</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;#ff0000&quot;</span>  <span class="c1"># Red for errors</span>
        <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;critical&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;#ff4500&quot;</span>  <span class="c1"># Orange for critical issues</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;#36a64f&quot;</span>  <span class="c1"># Green for info and other messages</span></div>

<div class="viewcode-block" id="AsyncGoloopWebsocket.send_slack_notification"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncGoloopWebsocket.send_slack_notification">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_slack_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message to Slack using attachments to add color and timestamp.</span>

<span class="sd">        :param message: The message to send to Slack.</span>
<span class="sd">        :param level: The log level (e.g., &#39;warn&#39;, &#39;error&#39;, &#39;info&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slack_webhook_url</span><span class="p">:</span>
            <span class="n">formatted_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">for_console</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;attachments&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;fallback&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Notification: </span><span class="si">{</span><span class="n">formatted_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slack_color_by_level</span><span class="p">(</span><span class="n">level</span><span class="p">),</span>  <span class="c1"># Green color for the attachment</span>
                                <span class="s2">&quot;pretext&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;*Notification received at </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">:*&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">formatted_message</span><span class="p">,</span>
                                <span class="s2">&quot;mrkdwn_in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;pretext&quot;</span><span class="p">],</span>  <span class="c1"># Enable Markdown in &#39;text&#39; and &#39;pretext&#39;</span>
                            <span class="p">}</span>
                        <span class="p">]</span>
                    <span class="p">}</span>

                    <span class="c1"># payload = {&quot;text&quot;: formatted_message}  # Slack Markdown format</span>

                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slack_webhook_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send Slack notification: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending Slack message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AsyncIconRpcHelper"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">AsyncIconRpcHelper</span><span class="p">(</span><span class="n">LoggerMixinVerbose</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper class for making asynchronous RPC calls to the ICON network.</span>
<span class="sd">    Provides methods to interact with the ICON blockchain, such as fetching blocks,</span>
<span class="sd">    transactions, and network information.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        url (str): The base URL for the RPC endpoint.</span>
<span class="sd">        logger (Optional[Union[logging.Logger, Console, ConsoleLoggerAdapter, Null]]): Logger instance for logging.</span>
<span class="sd">        session (aiohttp.ClientSession): HTTP session for making requests.</span>
<span class="sd">        verbose (bool): Flag to enable verbose logging.</span>
<span class="sd">        timeout (int): Request timeout in seconds.</span>
<span class="sd">        retries (int): Number of retry attempts for failed requests.</span>
<span class="sd">        return_with_time (bool): Whether to return elapsed time with responses.</span>
<span class="sd">        max_concurrency (int) : Number of max concurrency</span>

<span class="sd">    Methods:</span>
<span class="sd">        initialize(): Initializes the aiohttp session if not already initialized.</span>
<span class="sd">        close(): Closes the aiohttp session.</span>
<span class="sd">        execute_rpc_call(): Executes an RPC call to the ICON network.</span>
<span class="sd">        fetch(): Makes a generic HTTP request (GET or POST).</span>
<span class="sd">        get_block_hash(): Fetches block information by hash.</span>
<span class="sd">        get_last_blockheight(): Retrieves the height of the last block on the blockchain.</span>
<span class="sd">        get_network_info(): Fetches network information from the ICON blockchain.</span>
<span class="sd">        get_preps(): Retrieves a list of P-Reps from the ICON network.</span>
<span class="sd">        get_validator_info(): Retrieves validator information from the ICON network.</span>
<span class="sd">        get_tx_result(): Fetches transaction results, with optional retries and waiting.</span>

<span class="sd">    Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            import asyncio</span>
<span class="sd">            from pawnlib.utils.http import AsyncIconRpcHelper</span>

<span class="sd">            async def main():</span>
<span class="sd">                async with AsyncIconRpcHelper(url=&quot;https://icon-node-url.com&quot;) as rpc_helper:</span>
<span class="sd">                    # Fetch last block height</span>
<span class="sd">                    last_height = await rpc_helper.get_last_blockheight()</span>
<span class="sd">                    print(f&quot;Last Block Height: {last_height}&quot;)</span>

<span class="sd">                    # Get block hash by transaction hash</span>
<span class="sd">                    block_hash = await rpc_helper.get_block_hash(tx_hash=&quot;0x1234...&quot;)</span>
<span class="sd">                    print(f&quot;Block Hash: {block_hash}&quot;)</span>

<span class="sd">                    # Fetch P-Reps</span>
<span class="sd">                    preps = await rpc_helper.get_preps()</span>
<span class="sd">                    print(f&quot;P-Reps: {preps}&quot;)</span>

<span class="sd">            asyncio.run(main())</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span> <span class="n">Console</span><span class="p">,</span> <span class="n">ConsoleLoggerAdapter</span><span class="p">,</span> <span class="n">Null</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">return_with_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
            <span class="c1"># loop=None,</span>
            <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="c1"># self.logger = logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="c1"># self.logger = setup_logger(logger, &quot;pawnlib.http.AsyncIconRpcHelper&quot;, verbose=verbose)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="c1"># self.logger = self.get_logger()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">retries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_with_time</span> <span class="o">=</span> <span class="n">return_with_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrency</span> <span class="o">=</span> <span class="n">max_concurrency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>
        <span class="c1"># self.loop = loop or asyncio.get_running_loop()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_own_session</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">session</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_own_session</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start AsyncIconRpcHelper with max_concurrency=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_concurrency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">max_concurrency</span><span class="p">,</span>
            <span class="n">ssl</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssl&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">force_close</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_close&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">ttl_dns_cache</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ttl_dns_cache&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="p">)</span>    

<div class="viewcode-block" id="AsyncIconRpcHelper.adjust_concurrency"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.adjust_concurrency">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">adjust_concurrency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamically adjusts the maximum concurrency limit for asynchronous requests.</span>

<span class="sd">        Updates both the semaphore and TCP connector limits while migrating existing</span>
<span class="sd">        tasks to the new concurrency configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_max (int): New maximum number of concurrent connections (must be ≥1)</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If new_max is less than 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrency</span> <span class="o">=</span> <span class="n">new_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">new_max</span>
        <span class="n">old_sem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">new_max</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">new_max</span><span class="p">,</span> <span class="n">old_sem</span><span class="o">.</span><span class="n">_value</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concurrency_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitors current concurrency utilization.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary containing concurrency metrics:</span>
<span class="sd">                - active (int): Number of currently used connections</span>
<span class="sd">                - available (int): Number of available connections</span>
<span class="sd">                - max (int): Maximum allowed concurrent connections</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrency</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span>
            <span class="s2">&quot;available&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">semaphore</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_concurrency</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="AsyncIconRpcHelper.close"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.close">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_own_session</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Session explicitly closed&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">in</span> <span class="n">_ACTIVE_SESSIONS</span><span class="p">:</span>
                <span class="n">_ACTIVE_SESSIONS</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>  <span class="c1"># 추적 목록에서 제거</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unclosed session will be handled at program exit&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AsyncIconRpcHelper.initialize"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.initialize">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INIT START] Session=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="si">}</span><span class="s2">, closed=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
                <span class="n">connector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">connector</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">_ACTIVE_SESSIONS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>  <span class="c1"># 전역 목록에 세션 추가</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_own_session</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INIT] Created new session&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_ACTIVE_SESSIONS</span><span class="p">:</span>
                <span class="n">_ACTIVE_SESSIONS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>  <span class="c1"># 기존 세션도 추적</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_own_session</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[INIT] Using existing session from parent&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INIT END] Session=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="si">}</span><span class="s2">, own_session=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_own_session</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AIOHTTP session is closed or not initialized.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>            
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;AIOHTTP session is closed or not initialized.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="AsyncIconRpcHelper.execute_rpc_call"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.execute_rpc_call">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_rpc_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute an RPC call to the ICON network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">append_api_v3</span><span class="p">(</span><span class="n">_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">governance_address</span><span class="p">:</span>
            <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;icx_call&quot;</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">governance_address</span><span class="p">,</span>
                    <span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;call&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
            <span class="n">http_method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">request_data</span><span class="p">,</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">,</span>
            <span class="n">return_on_error</span><span class="o">=</span><span class="n">return_on_error</span><span class="p">,</span>
            <span class="n">keep_lists</span><span class="o">=</span><span class="n">keep_lists</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.fetch"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.fetch">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">http_method</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_on_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">list_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># async with self.semaphore:</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">remove_path_from_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="si">}{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FETCH START] </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">, Session=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">retries</span><span class="p">:</span>
            <span class="n">retries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retries</span>

        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_request</span><span class="p">(</span>
            <span class="n">http_method</span><span class="o">=</span><span class="n">http_method</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">,</span>
            <span class="n">return_on_error</span><span class="o">=</span><span class="n">return_on_error</span><span class="p">,</span>
            <span class="n">return_first</span><span class="o">=</span><span class="n">return_first</span><span class="p">,</span>
            <span class="n">list_index</span><span class="o">=</span><span class="n">list_index</span><span class="p">,</span>
            <span class="n">retries</span><span class="o">=</span><span class="n">retries</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.check_aio_session"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.check_aio_session">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_aio_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;AIOHTTP session is closed or not initialized.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>            
            <span class="k">if</span> <span class="n">log_exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_on_error</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span></div>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_make_request</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">return_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">return_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">return_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">list_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">backoff_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">keep_lists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">log_exception</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">return_with_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to make HTTP requests with retry and timeout support.</span>

<span class="sd">        Args:</span>
<span class="sd">            http_method (str): HTTP method (&#39;GET&#39;, &#39;POST&#39;, etc.).</span>
<span class="sd">            endpoint (str): API endpoint or full URL.</span>
<span class="sd">            data (dict or str, optional): Payload for POST requests or query parameters for GET.</span>
<span class="sd">            headers (dict, optional): HTTP headers.</span>
<span class="sd">            return_key (str, optional): Key to extract from the JSON response.</span>
<span class="sd">            return_on_error (bool, optional): Whether to return data on error responses.</span>
<span class="sd">            return_first (bool, optional): If True and response is a list, return the first item.</span>
<span class="sd">            list_index (int, optional): If provided and response is a list, return the item at this index.</span>
<span class="sd">            retries (int, optional): Number of retry attempts. Defaults to 3.</span>
<span class="sd">            backoff_factor (float, optional): Backoff factor for exponential delay. Defaults to 0.5.</span>
<span class="sd">            keep_lists (bool, optional): Whether to keep lists in flattened data.</span>
<span class="sd">            log_exception (bool, optional): Whether to log exceptions.</span>
<span class="sd">            return_with_time (bool, optional): If True, return response data along with the elapsed time.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: Processed response data, or a tuple of response data and elapsed time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use class-level default for return_with_time if not explicitly provided</span>
        <span class="k">if</span> <span class="n">return_with_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_with_time</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;return_with_time&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> request to </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> with data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure session is valid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_aio_session</span><span class="p">(</span><span class="n">log_exception</span><span class="p">,</span> <span class="n">return_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># Start timer for elapsed time</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>                        
                        <span class="n">response_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                        <span class="n">response_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported HTTP method: </span><span class="si">{</span><span class="n">http_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">({},</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="p">{}</span>

                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">response_text</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time</span>
                <span class="p">}</span>

                <span class="c1"># Handle successful response</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">processed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="n">keep_lists</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">return_first</span><span class="p">:</span>
                                <span class="n">processed_response</span> <span class="o">=</span> <span class="n">processed_response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">processed_response</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="k">elif</span> <span class="n">list_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">processed_response</span> <span class="o">=</span> <span class="n">processed_response</span><span class="p">[</span><span class="n">list_index</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list_index</span> <span class="k">else</span> <span class="kc">None</span>

                        <span class="k">return</span> <span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="n">processed_response</span>
                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode JSON response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="n">response_text</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{}</span>
                <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                        <span class="n">processed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;error.message&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">processed_response</span> <span class="o">=</span> <span class="n">processed_response</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Executing: &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ▶️ </span><span class="si">{</span><span class="n">get_shortened_tx_hash</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> status=</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">, response=</span><span class="si">{</span><span class="n">processed_response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;▶️ Failed to decode JSON response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request failed with status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">return_on_error</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                            <span class="n">processed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="n">keep_lists</span><span class="p">)</span>
                            <span class="k">return</span> <span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="n">processed_response</span>
                        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="n">response_text</span>
                    <span class="k">return</span> <span class="p">({},</span> <span class="n">elapsed_time</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="p">{}</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Method: </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Method: </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">retries</span> <span class="ow">and</span> <span class="n">return_with_time</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">({},</span> <span class="n">elapsed_time</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Method: </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="n">log_exception</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">return_with_time</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">({},</span> <span class="n">elapsed_time</span><span class="p">)</span>
                    <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="c1"># Adding jitter to introduce randomness in the backoff time, preventing thundering herd problem.</span>
                    <span class="n">jitter</span> <span class="o">=</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">jitter</span>
                    <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying after </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds..., URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">, data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="c1"># Final fallback in case all retries fail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts failed for </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> request to </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">({},</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="p">{}</span>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_make_request</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">return_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">return_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">return_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">list_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">backoff_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">keep_lists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">log_exception</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">return_with_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to make HTTP requests with retry and timeout support.</span>
<span class="sd">        Stores response in last_response and maintains legacy return behavior.</span>

<span class="sd">        Args:</span>
<span class="sd">            http_method (str): HTTP method (&#39;GET&#39;, &#39;POST&#39;, etc.).</span>
<span class="sd">            endpoint (str): API endpoint or full URL.</span>
<span class="sd">            data (dict or str, optional): Payload for POST requests or query parameters for GET.</span>
<span class="sd">            headers (dict, optional): HTTP headers.</span>
<span class="sd">            return_key (str, optional): Key to extract from the JSON response.</span>
<span class="sd">            return_on_error (bool, optional): Whether to return data on error responses.</span>
<span class="sd">            return_first (bool, optional): If True and response is a list, return the first item.</span>
<span class="sd">            list_index (int, optional): If provided and response is a list, return the item at this index.</span>
<span class="sd">            retries (int, optional): Number of retry attempts. Defaults to 3.</span>
<span class="sd">            backoff_factor (float, optional): Backoff factor for exponential delay. Defaults to 0.5.</span>
<span class="sd">            keep_lists (bool, optional): Whether to keep lists in flattened data.</span>
<span class="sd">            log_exception (bool, optional): Whether to log exceptions.</span>
<span class="sd">            return_with_time (bool, optional): If True, return response data along with the elapsed time.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: Processed response data, or a tuple of response data and elapsed time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">return_with_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_with_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_with_time</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Making </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> request to </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2"> with data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_http_request</span><span class="p">(</span><span class="n">http_method</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
                <span class="n">response_text</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;response_text&quot;</span><span class="p">]</span>
                <span class="n">elapsed_time_ms</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">processed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_success_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">return_key</span><span class="p">,</span> <span class="n">keep_lists</span><span class="p">,</span> <span class="n">return_first</span><span class="p">,</span> <span class="n">list_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">processed_response</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time_ms</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="n">elapsed_time_ms</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="n">processed_response</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_error_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">return_on_error</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">error_message</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{},</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">,</span>
                        <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time_ms</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ▶️ </span><span class="si">{</span><span class="n">get_shortened_tx_hash</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> status=</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">, error=</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">elapsed_time_ms</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{},</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Request failed with status </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time_ms</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
                    <span class="n">processed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_error_response</span><span class="p">(</span><span class="n">response_text</span><span class="p">,</span> <span class="n">return_on_error</span><span class="p">,</span> <span class="n">return_key</span><span class="p">,</span> <span class="n">keep_lists</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_response</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="n">elapsed_time_ms</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="n">processed_response</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">elapsed_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{},</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time_ms</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Method: </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">elapsed_time_ms</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">elapsed_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{},</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time_ms</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Method: </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">, URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">log_exception</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="n">elapsed_time_ms</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">backoff_factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">sleep_time</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying after </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds..., URL: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">, data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{},</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="n">retries</span><span class="si">}</span><span class="s2"> attempts failed for </span><span class="si">{</span><span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> request to </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_with_time</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_response</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_execute_http_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the HTTP request and returns response details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span>
                <span class="n">response_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">http_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">data</span>
            <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span>
                <span class="n">response_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported HTTP method: </span><span class="si">{</span><span class="n">http_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">elapsed_time_ms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="s2">&quot;response_text&quot;</span><span class="p">:</span> <span class="n">response_text</span><span class="p">,</span>
            <span class="s2">&quot;elapsed_time_ms&quot;</span><span class="p">:</span> <span class="n">elapsed_time_ms</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_success_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">keep_lists</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">return_first</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">list_index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes successful (200) response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
            <span class="n">processed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="n">keep_lists</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processed_response</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">return_first</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">processed_response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">processed_response</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">list_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">processed_response</span><span class="p">[</span><span class="n">list_index</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">list_index</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">processed_response</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode JSON response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response_text</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_error_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">return_on_error</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">return_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keep_lists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes error response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_key</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">response_json</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="n">keep_lists</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response_json</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_text</span> <span class="k">if</span> <span class="n">return_on_error</span> <span class="k">else</span> <span class="p">{}</span>
        

<div class="viewcode-block" id="AsyncIconRpcHelper.handle_response_with_key"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.handle_response_with_key">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_response_with_key</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">return_key</span> <span class="ow">and</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">flat</span> <span class="o">=</span> <span class="n">Flattener</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">keep_lists</span><span class="o">=</span><span class="n">keep_lists</span><span class="p">)</span>
                <span class="c1"># return Flattener(response, keep_lists=keep_lists).get(return_key)</span>
                <span class="k">return</span> <span class="n">FlatDict</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">return_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_block_hash"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_block_hash">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_block_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">hash_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hash_info</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icx_getBlockByHash&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="n">tx_hash</span><span class="p">},</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during operation get_block_hash(): </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hash_info</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_last_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_last_blockheight">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_last_blockheight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icx_getLastBlock&#39;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.height&quot;</span><span class="p">)</span>        
        <span class="k">return</span> <span class="n">response</span> <span class="k">if</span> <span class="n">response</span> <span class="k">else</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_network_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_network_info">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_network_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icx_getNetworkInfo&#39;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span> <span class="k">if</span> <span class="n">response</span> <span class="k">else</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_preps"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_preps">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_preps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_dict_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span> <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getPReps&#39;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.preps&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_dict_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">list_to_dict_by_key</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">return_dict_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_balance"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_balance">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icx_getBalance&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span>
            <span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_stake"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_stake">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_stake</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
            <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getStake&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span>
            <span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="c1"># use_hex_value = use_hex_value or self.use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_delegation"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_delegation">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_delegation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
            <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getDelegation&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span>
            <span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>
        <span class="c1"># use_hex_value = use_hex_value or self.use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="AsyncIconRpcHelper.get_bond"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_bond">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
            <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getBond&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span>
            <span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="c1"># use_hex_value = use_hex_value or self.use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_iscore"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_iscore">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_iscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">return_as_hex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">use_hex_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">return_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
            <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;queryIScore&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">address</span>
            <span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="n">return_key</span>
        <span class="p">)</span>

        <span class="c1"># use_hex_value = use_hex_value or self.use_hex_value</span>
        <span class="k">if</span> <span class="n">use_hex_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HexValueParser</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_as_hex</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">return_value</span>
        <span class="k">return</span> <span class="n">hex_to_number</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">is_tint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="AsyncIconRpcHelper.get_node_name_by_address"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_node_name_by_address">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_node_name_by_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a dictionary mapping node addresses to their corresponding names.</span>

<span class="sd">        This function calls `get_preps` to fetch the full dictionary of P-Rep information</span>
<span class="sd">        and then filters it to create a new dictionary where the keys are `nodeAddress`</span>
<span class="sd">        and the values are `name`.</span>

<span class="sd">        :return: A dictionary with `nodeAddress` as keys and `name` as values.</span>
<span class="sd">        :rtype: dict</span>

<span class="sd">        Example:</span>
<span class="sd">            .. code-block:: python</span>

<span class="sd">                # Example output</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;hx12ffd8a005f9bc0a3164c2d133a0ed5ecfe70c21&quot;: &quot;Clue&quot;,</span>
<span class="sd">                    &quot;hx34a8e8a005f9bc0b3164c2d133a0ed5ecfe70c22&quot;: &quot;NodeX&quot;,</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">preps_info</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preps</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">return_dict_key</span><span class="o">=</span><span class="s2">&quot;nodeAddress&quot;</span><span class="p">)</span>

        <span class="c1"># Create a new dictionary with nodeAddress as the key and name as the value</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">address</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">address</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">preps_info</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_validator_info"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_validator_info">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_validator_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
            <span class="n">governance_address</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">CHAIN_SCORE_ADDRESS</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;getValidatorsInfo&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataType&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">},</span>
            <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result.validators&quot;</span>
        <span class="p">)</span></div>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_tx_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="k">return</span>  <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_rpc_call</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;icx_getTransactionResult&#39;</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="n">tx_hash</span><span class="p">})</span>

<div class="viewcode-block" id="AsyncIconRpcHelper.get_tx_result"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.AsyncIconRpcHelper.get_tx_result">[docs]</a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_tx_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">is_wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">target_url</span> <span class="o">=</span> <span class="n">url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">tx_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tx_result</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_wait</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_response_with_key</span><span class="p">(</span><span class="n">tx_result</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="n">tx_result</span><span class="p">)</span>

        <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_attempts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requesting transaction result for tx_hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2"> (Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="n">tx_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tx_result</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tx_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">flatten_tx_result</span> <span class="o">=</span> <span class="n">FlatDict</span><span class="p">(</span><span class="n">tx_result</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flatten_tx_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flatten_tx_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result.failure&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">flatten_tx_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;result.failure&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">flatten_tx_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error.message&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>

            <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Wait before retrying</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max attempts reached. Failed to get transaction result for tx_hash: </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;Failed to get transaction result&quot;</span></div></div>


<div class="viewcode-block" id="gen_rpc_params"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.gen_rpc_params">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">gen_rpc_params</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">default_rpc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">default_rpc</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">return</span> <span class="n">default_rpc</span></div>


<div class="viewcode-block" id="getBlockByHash"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.getBlockByHash">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">getBlockByHash</span><span class="p">(</span><span class="n">nodeHost</span><span class="p">,</span> <span class="nb">hash</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodeHost</span><span class="si">}</span><span class="s2">/api/v3&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">gen_rpc_params</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getBlockByHash&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hash&quot;</span><span class="p">:</span> <span class="nb">hash</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>


<div class="viewcode-block" id="getTransactionByHash"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.getTransactionByHash">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">getTransactionByHash</span><span class="p">(</span><span class="n">nodeHost</span><span class="p">,</span> <span class="nb">hash</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodeHost</span><span class="si">}</span><span class="s2">/api/v3&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">gen_rpc_params</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getTransactionByHash&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;txHash&quot;</span><span class="p">:</span> <span class="nb">hash</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span></div>


<div class="viewcode-block" id="getLastBlock"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.getLastBlock">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">getLastBlock</span><span class="p">(</span><span class="n">nodeHost</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodeHost</span><span class="si">}</span><span class="s2">/api/v3&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">gen_rpc_params</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;icx_getLastBlock&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">json_res</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">json_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json_res</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="jequest"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.jequest">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">jequest</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{},</span> <span class="n">elapsed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This functions will be called the http requests.</span>

<span class="sd">    :param url:</span>
<span class="sd">    :param method:</span>
<span class="sd">    :param payload:</span>
<span class="sd">    :param elapsed:</span>
<span class="sd">    :param print_error:</span>
<span class="sd">    :param timeout: Timeout seconds</span>
<span class="sd">    :param ipaddr: Change the request IP address in http request</span>
<span class="sd">    :param verify: verify SSL</span>
<span class="sd">    :param \*\*kwargs: Optional arguments that ``request`` takes.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ipaddr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">):</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https?://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="c1"># net.override_dns(domain, ipaddr)</span>
            <span class="c1"># net.override_dns(domain=domain, ipaddr=ipaddr)</span>
            <span class="n">net</span><span class="o">.</span><span class="n">OverrideDNS</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">ipaddr</span><span class="o">=</span><span class="n">ipaddr</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">net</span><span class="o">.</span><span class="n">OverrideDNS</span><span class="p">()</span><span class="o">.</span><span class="n">unset</span><span class="p">()</span>

    <span class="n">pawnlib_timeout</span> <span class="o">=</span> <span class="n">pawn</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PAWN_TIMEOUT&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pawnlib_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pawnlib_timeout</span> <span class="o">=</span> <span class="n">pawnlib_timeout</span> <span class="o">/</span> <span class="mi">1000</span>

    <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">pawnlib_timeout</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">append_http</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">(</span><span class="n">json_response</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">http_version</span><span class="p">,</span> <span class="n">r_headers</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="o">=</span> <span class="p">({},</span> <span class="p">{},</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">):</span>
        <span class="c1"># cprint(f&quot;[ERROR] unsupported method={method}, url={url} &quot;, color=&quot;red&quot;)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, url=</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;unsupported method&quot;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">http_version</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">version</span>
        <span class="n">r_headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">errh</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">errh</span>
        <span class="k">if</span> <span class="n">global_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kvPrint</span><span class="p">(</span><span class="s2">&quot;Http Error:&quot;</span><span class="p">,</span> <span class="n">errh</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Http Error:</span><span class="si">{</span><span class="n">errh</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">errc</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">errc</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;[Errno 11001] getaddrinfo failed&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">errc</span><span class="p">)</span> <span class="ow">or</span>  <span class="c1"># Windows</span>
                <span class="s2">&quot;[Errno -2] Name or service not known&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">errc</span><span class="p">)</span> <span class="ow">or</span>  <span class="c1"># Linux</span>
                <span class="s2">&quot;[Errno 8] nodename nor servname &quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">errc</span><span class="p">)):</span>  <span class="c1"># OS X</span>
            <span class="n">errc</span> <span class="o">=</span> <span class="s2">&quot;DNSLookupError&quot;</span>
        <span class="k">if</span> <span class="n">global_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kvPrint</span><span class="p">(</span><span class="s2">&quot;Error Connecting:&quot;</span><span class="p">,</span> <span class="n">errc</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error Connecting:</span><span class="si">{</span><span class="n">errc</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">errt</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">errt</span>
        <span class="k">if</span> <span class="n">global_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kvPrint</span><span class="p">(</span><span class="s2">&quot;Timeout Error:&quot;</span><span class="p">,</span> <span class="n">errt</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout Connecting:</span><span class="si">{</span><span class="n">errt</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">err</span>
        <span class="k">if</span> <span class="n">global_verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kvPrint</span><span class="p">(</span><span class="s2">&quot;OOps: Something Else&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s2">&quot;FAIL&quot;</span><span class="p">)</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OOps: Something Else:</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="c1"># cprint(f&quot;----&gt; {url}, {method}, {payload} , {response.status_code}&quot;, &quot;green&quot;)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response_code</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">response_code</span> <span class="o">=</span> <span class="mi">999</span>

    <span class="n">json_payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">global_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">debug_logging</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">json_payload</span><span class="si">}</span><span class="s2"> , </span><span class="si">{</span><span class="n">response_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response_code</span> <span class="o">!=</span> <span class="mi">999</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">json_response</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
            <span class="c1"># debug_logging(f&quot;{url} , response is not json -&gt; &#39;{response.text}&#39;&quot;)</span>

        <span class="k">if</span> <span class="n">elapsed</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">elapsed</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_response</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">json_response</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;elapsed&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">response_code</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">response_code</span> <span class="o">!=</span> <span class="mi">999</span> <span class="ow">and</span> <span class="n">print_error</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status_code: </span><span class="si">{</span><span class="n">response_code</span><span class="si">}</span><span class="s2"> , url: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> , payload: </span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, response: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_code</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;http_version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">http_version</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;r_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_headers</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_response</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
    <span class="k">if</span> <span class="n">print_error</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pawn</span><span class="o">.</span><span class="n">error_logger</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

    <span class="n">pawn</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;url=</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">, method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">, payload=</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s2">, kwargs=</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">, error=</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="get_blockheight"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.get_blockheight">[docs]</a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_blockheight</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to parse block height from a response.</span>

<span class="sd">    :param response: The response containing block height data.</span>
<span class="sd">    :return: Parsed block height.</span>
<span class="sd">    :raises: Exception if block height parsing fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">blockheight</span> <span class="o">=</span> <span class="n">response_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blockheight</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Block height not found in the response&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">blockheight</span></div>


<div class="viewcode-block" id="retry_operation"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.retry_operation">[docs]</a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retry_operation</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">success_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retry the given operation multiple times in case of failure or based on the success criteria.</span>

<span class="sd">    :param operation: The operation to retry (function).</span>
<span class="sd">    :param max_attempts: Maximum number of retry attempts.</span>
<span class="sd">    :param delay: Delay between retries.</span>
<span class="sd">    :param success_criteria: A function that takes the result and returns True if the result is valid/successful.</span>
<span class="sd">    :param logger: Logger for logging messages (optional).</span>
<span class="sd">    :param verbose: Verbosity level for logging.</span>
<span class="sd">    :param args: Positional arguments to pass to the operation.</span>
<span class="sd">    :param kwargs: Keyword arguments to pass to the operation.</span>
<span class="sd">    :return: The result of the operation if successful.</span>
<span class="sd">    :raises: Exception if the operation fails after max_attempts or success criteria is not met.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">_logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="s2">&quot;retry_operation&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">max_attempts</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">operation</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success_criteria</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">success_criteria</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">success_criteria</span><span class="p">:</span>
                        <span class="n">success_criteria_name</span> <span class="o">=</span> <span class="n">success_criteria</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">success_criteria_name</span> <span class="o">=</span> <span class="n">success_criteria</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation result did not meet success criteria (Attempt </span><span class="si">{</span><span class="n">attempts</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2">), success_criteria=</span><span class="si">{</span><span class="n">success_criteria_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during operation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (Attempt </span><span class="si">{</span><span class="n">attempts</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">max_attempts</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> seconds...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max attempts reached. Operation failed after </span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2"> attempts.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation failed after </span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_path_from_url"><a class="viewcode-back" href="../../../module/pawnlib.utils.html#pawnlib.utils.http.remove_path_from_url">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">remove_path_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the path, query, and fragment from a URL, leaving only the scheme and domain.</span>

<span class="sd">    Args:</span>
<span class="sd">        url (str): The original URL.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The URL without the path, query, or fragment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the position of &quot;://&quot; to identify where the scheme ends</span>
    <span class="n">scheme_end</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;://&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scheme_end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid URL: Missing scheme (e.g., &#39;http://&#39;).&quot;</span><span class="p">)</span>

    <span class="c1"># Find the first slash after the domain</span>
    <span class="n">domain_end</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">scheme_end</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">domain_end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># No path, query, or fragment in the URL</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="c1"># Extract and return the URL up to the domain</span>
    <span class="k">return</span> <span class="n">url</span><span class="p">[:</span><span class="n">domain_end</span><span class="p">]</span></div>


<span class="n">icon_rpc_call</span> <span class="o">=</span> <span class="n">IconRpcHelper</span><span class="p">()</span><span class="o">.</span><span class="n">rpc_call</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, jinwoo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>